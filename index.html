<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
  <meta name="theme-color" content="#f2f2f7" id="theme-color-meta">
  <title>Alerta Vecinal</title>
  
  <link rel="apple-touch-icon" href="icono.png">
  <link rel="manifest" href="manifest.json">
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

  <style>
    /* VARIABLES Y DISE√ëO NATIVO PREMIUM */
    :root { 
      --primary: #007aff; --primary-dim: rgba(0, 122, 255, 0.15);
      --success: #34c759; --danger: #dc2626; --danger-dark: #991b1b;
      --bg-body: #f2f2f7; --bg-card: #ffffff;
      --text-main: #000000; --text-sec: #8e8e93;
      --border: rgba(0,0,0,0.08); --shadow: 0 8px 30px rgba(0,0,0,0.08);
      --radius-md: 16px;
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
    }
    [data-theme="oscuro"] {
      --primary: #0a84ff; --primary-dim: rgba(10, 132, 255, 0.2);
      --success: #30d158; --danger: #ef4444; --danger-dark: #b91c1c;
      --bg-body: #000000; --bg-card: #1c1c1e;
      --text-main: #ffffff; --text-sec: #98989d;
      --border: rgba(255,255,255,0.1); --shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    [data-theme="duotono"] {
      --primary: #60a5fa; --primary-dim: rgba(96, 165, 250, 0.2);
      --success: #34d399; --danger: #f43f5e; --danger-dark: #e11d48;
      --bg-body: #111827; --bg-card: rgba(31, 41, 55, 0.7);
      --text-main: #f3f4f6; --text-sec: #9ca3af;
      --border: rgba(255,255,255,0.08); --shadow: 0 8px 30px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: var(--font-stack); background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; background-image: radial-gradient(circle at top left, var(--primary-dim), transparent 40%), radial-gradient(circle at bottom right, rgba(255, 59, 48, 0.05), transparent 40%); }
    
    .container { width: 100%; height: 100%; max-width: 480px; background: var(--bg-card); position: relative; overflow-y: auto; display: flex; flex-direction: column; padding: calc(20px + var(--safe-area-top)) 24px calc(20px + var(--safe-area-bottom)); }
    @media (min-width: 500px) { .container { height: auto; max-height: 90vh; border-radius: 40px; box-shadow: var(--shadow); border: 1px solid var(--border); } }

    h2 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; letter-spacing: -0.5px; }
    p { font-size: 16px; color: var(--text-sec); margin: 0; line-height: 1.5; }

    .pin-input { background: transparent; border: none; border-bottom: 2px solid var(--border); font-size: 48px; font-weight: 700; letter-spacing: 12px; text-align: center; width: 80%; margin: 40px auto; color: var(--text-main); display: block; border-radius: 0; font-family: monospace; }
    .pin-input:focus { outline: none; border-bottom-color: var(--primary); }

    button { border: none; border-radius: var(--radius-md); font-size: 17px; font-weight: 600; padding: 16px; cursor: pointer; transition: transform 0.1s, opacity 0.2s; width: 100%; position: relative; overflow: hidden; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
    button:active { transform: scale(0.97); opacity: 0.9; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-dim); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--primary); margin-top: 10px; }
    .btn-logout { background: transparent; color: var(--text-sec); font-size: 14px; margin-top: auto; padding: 20px 0; }
    .btn-success { background: var(--success); color: white; font-size: 18px; height: 60px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3); }

    .btn-llegando { background: linear-gradient(135deg, var(--success), #28a745); color: white; font-size: 20px; font-weight: 800; height: 75px; display: flex; align-items: center; justify-content: center; gap: 12px; border-radius: 20px; box-shadow: 0 8px 20px rgba(52, 199, 89, 0.3); text-transform: uppercase; letter-spacing: 1px; }
    .btn-danger-garita { background: var(--danger); color: white; border: none; border-radius: var(--radius-md); box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4); }

    /* BOTON SOS SERIO Y REDISE√ëADO */
    .sos-wrapper { display: flex; justify-content: center; align-items: center; margin: 35px 0; position: relative; }
    .sos-container { 
      width: 210px; height: 210px; position: relative; border-radius: 50%; 
      background: var(--danger); 
      box-shadow: 0 15px 35px rgba(220, 38, 38, 0.4), inset 0 0 0 6px rgba(255,255,255,0.2); 
      display: flex; justify-content: center; align-items: center; overflow: hidden;
      border: 4px solid var(--bg-card);
    }
    #btn-sos { 
      width: 100%; height: 100%; border-radius: 50%; background: transparent; 
      color: #ffffff; font-size: 46px; font-weight: 900; z-index: 2; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0; 
      text-shadow: 0 2px 5px rgba(0,0,0,0.3); letter-spacing: 2px;
    }
    #sos-progress { 
      position: absolute; bottom: 0; left: 0; width: 0%; height: 100%; 
      background: rgba(0, 0, 0, 0.25); z-index: 1; pointer-events: none; 
      transition: width 0.1s linear;
    }
    .sos-hint { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; opacity: 0.9; color: #ffffff; text-shadow: none; }
    .sos-bloqueado { background: var(--danger-dark) !important; color: #fca5a5 !important; pointer-events: none; }
    
    @keyframes heartbeat { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); transform: scale(1); } 70% { box-shadow: 0 0 0 25px rgba(220, 38, 38, 0); transform: scale(1.02); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); transform: scale(1); } }
    .sos-container::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; animation: heartbeat 2s infinite; z-index: 0; border: 4px solid var(--danger); opacity: 0.15; }

    .vista { display: none; height: 100%; flex-direction: column; }
    .vista-activa { display: flex; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .historial-item, .tarjeta { background: var(--bg-body); padding: 16px; margin-bottom: 12px; border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 500; }
    .tarjeta { flex-direction: column; align-items: flex-start; border-left: 5px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); background: var(--bg-card); }
    .tarjeta.sos { border-left-color: var(--danger); background: rgba(220, 38, 38, 0.05); }

    .tarjeta.sos-urgente { border: 3px solid var(--danger); background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, rgba(220, 38, 38, 0.15) 100%); animation: pulse-sos 1.5s infinite; transform: scale(1.02); margin-bottom: 20px; }
    @keyframes pulse-sos { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); } 70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

    .grid-botones { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .grid-botones button { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); height: auto; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; gap: 8px; border-radius: 20px; }
    .grid-botones button span { font-size: 28px; }

    .modal-overlay { background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 9999; position: fixed; top:0; left:0; right:0; bottom:0; display: none; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-card); width: 90%; max-width: 360px; border-radius: 32px; padding: 30px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; }
    .custom-textarea { width: 100%; background: var(--bg-body); border: 1px solid var(--border); padding: 15px; border-radius: 12px; font-family: inherit; color: var(--text-main); margin: 15px 0; box-sizing: border-box; resize: none; text-align: left;}

    .toast-notificacion { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(50, 50, 50, 0.9); backdrop-filter: blur(10px); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    .toast-show { top: 40px; }
    
    .estado-respuesta-sos { background: #ffe5e5; color: #d70015; border: 2px solid #d70015; padding: 15px; border-radius: 16px; margin-bottom: 15px; animation: heartbeat 2s infinite; }
    [data-theme="oscuro"] .estado-respuesta-sos { background: #3a0000; color: #ff6b6b; border-color: #ef4444; }

    .theme-selector { background: var(--bg-body); padding: 4px; border-radius: 14px; display: flex; margin: 20px 0; }
    .theme-selector button { background: transparent; color: var(--text-sec); padding: 8px; border-radius: 10px; font-size: 12px; box-shadow: none; }
    .theme-selector button.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .login-icon { font-size: 60px; margin-bottom: 20px; background: var(--bg-body); width: 120px; height: 120px; border-radius: 40px; display: inline-flex; align-items: center; justify-content: center; }

    /* SPINNER PREMIUM MEJORADO */
    .modern-spinner {
      width: 50px; height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- MODALES DE FLUJO Y PERMISOS -->
  <div id="modal-permisos" class="modal-overlay"><div class="modal-content"><div style="font-size: 50px; margin-bottom: 15px;">üìçüîî</div><h3>Permisos Necesarios</h3><p>Habilita la ubicaci√≥n y notificaciones para protegerte mejor.</p><button class="btn-primary" onclick="concederPermisosVecino()" style="margin-top: 20px;">Habilitar Todo</button></div></div>
  
  <div id="modal-confirmacion" class="modal-overlay"><div class="modal-content"><div style="font-size: 50px; margin-bottom: 10px;">‚ö†Ô∏è</div><h3>¬øEnviar Alerta?</h3><p id="texto-motivo-alerta" style="font-weight: 700; color: var(--danger); margin: 10px 0;"></p><p>Se notificar√° a todos los vecinos.</p><div style="display: flex; gap: 10px; margin-top: 20px;"><button class="btn-outline" onclick="cerrarModalConfirmacion()" style="margin:0; border:none; background: var(--bg-body); color: var(--text-main);">Cancelar</button><button class="btn-primary" id="btn-ejecutar-alerta" style="margin:0; background: var(--danger);">S√≠, Enviar</button></div></div></div>
  
  <div id="modal-aviso-custom" class="modal-overlay"><div class="modal-content"><h3>Mensaje a Vecinos</h3><textarea id="input-aviso-custom" class="custom-textarea" rows="3" placeholder="Escriba el aviso que recibir√°n todos los vecinos..."></textarea><div style="display: flex; gap: 10px;"><button class="btn-outline" onclick="cerrarModalAvisoCustom()" style="margin:0;">Cancelar</button><button class="btn-primary" onclick="confirmarAvisoCustom()" style="margin:0;">Enviar Aviso</button></div></div></div>
  
  <div id="modal-alerta" class="modal-overlay"><div class="modal-content" style="border-color: var(--danger);"><div style="font-size: 60px; margin-bottom: 15px; animation: heartbeat 1s infinite;">üö®</div><h3 style="color: var(--danger);">ALERTA VECINAL</h3><p id="texto-alerta-recibida" style="font-size: 18px; font-weight: 700; color: var(--text-main);"></p><button class="btn-primary" onclick="cerrarModalAlerta()" style="margin-top: 20px; background: var(--danger);">Entendido</button></div></div>
  
  <div id="toast-exito" class="toast-notificacion">‚úÖ Operaci√≥n exitosa</div>
  
  <!-- SPINNER REDISE√ëADO -->
  <div id="loader" class="modal-overlay" style="z-index: 10000; display: none;">
    <div style="background: var(--bg-card); padding: 30px 40px; border-radius: 24px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
       <div class="modern-spinner"></div>
       <p id="loader-text" style="margin-top: 15px; font-weight: 600; color: var(--text-main); font-size: 15px;">Conectando...</p>
    </div>
  </div>

  <div class="container">
    <!-- VISTA LOGIN -->
    <div class="vista" id="vista-login">
      <div><div class="login-icon">üõ°Ô∏è</div><h2>Bienvenido</h2><p>Introduce tu PIN de seguridad</p><input type="password" id="inputId" class="pin-input" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="chequearPin(this)"><div id="login-error" style="color: var(--danger); margin-top: 20px; font-weight: 600; min-height: 20px;"></div></div>
    </div>

    <!-- VISTA VECINO -->
    <div class="vista" id="vista-vecino">
      <header style="margin-bottom: 20px; text-align: left;"><h2 id="vecino-nombre" style="color: var(--primary);">Vecino</h2><p id="vecino-domicilio" style="display: flex; align-items: center; gap: 6px;"><span style="font-size: 14px;">üìç</span> Cargando direcci√≥n...</p></header>
      <button class="btn-llegando" onclick="registrarLlegada()"><span>üöó</span> ESTOY LLEGANDO</button>
      <div id="mensaje-estado" style="text-align: center; margin: 15px 0; font-weight: 600; min-height: 24px;"></div>
      
      <div class="sos-wrapper">
        <div class="sos-container">
          <div id="sos-progress"></div>
          <button id="btn-sos">
            SOS
            <span class="sos-hint" id="sos-instruccion">MANTENER PRESIONADO</span>
          </button>
        </div>
      </div>

      <div style="flex: 1; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><h3 style="margin:0; font-size: 16px; color: var(--text-sec);">Actividad Reciente</h3><span style="font-size: 12px; color: var(--text-sec);">Autorefresh activo</span></div>
        <div id="lista-historial"></div>
      </div>
      <div class="theme-selector"><button id="btn-tema-claro" onclick="cambiarTema('claro')" style="flex:1;">‚òÄÔ∏è Claro</button><button id="btn-tema-oscuro" onclick="cambiarTema('oscuro')" style="flex:1;">üåô Oscuro</button><button id="btn-tema-duotono" onclick="cambiarTema('duotono')" style="flex:1;">‚ú® Color</button></div>
      <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>

    <!-- VISTA GARITA -->
    <div class="vista" id="vista-garita">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2>CENTRAL GARITA</h2><button class="btn-logout" onclick="cerrarSesion()" style="width: auto; padding: 5px 10px; margin: 0; border-radius: 8px;">Salir</button></header>
      
      <!-- BOT√ìN ADVERTENCIA AUDIO INICIAL: Oculto por defecto si el usuario toca la pantalla -->
      <button id="btn-habilitar-push" class="btn-danger-garita" onclick="habilitarNotificacionesGuardia()" style="margin-bottom: 20px; animation: pulse-sos 2s infinite; text-transform: uppercase; display: none;">‚ö†Ô∏è Tocar aqu√≠ para activar sirena</button>
      
      <div id="lista-avisos" style="flex: 1; overflow-y: auto; padding-bottom: 20px; min-height: 150px;"></div>
      <hr style="border: 0; border-top: 1px solid var(--border); margin: 10px 0 20px 0;">
      <h3 style="font-size: 14px; color: var(--text-sec); margin-bottom: 10px; text-align: left;">GENERAR ALERTA GLOBAL</h3>
      <div class="grid-botones">
        <button onclick="abrirModalConfirmacion('Sospechoso merodeando')"><span>üïµÔ∏è‚Äç‚ôÇÔ∏è</span>Sospechoso</button>
        <button onclick="abrirModalConfirmacion('Veh√≠culo desconocido')"><span>üöò</span>Veh√≠culo</button>
        <button onclick="abrirModalConfirmacion('Ruidos molestos detectados')"><span>üîä</span>Ruidos</button>
        <button onclick="abrirModalConfirmacion('Falla de suministro el√©ctrico/agua')"><span>‚ö†Ô∏è</span>Servicios</button>
        <button onclick="abrirModalConfirmacion('Incendio o humo detectado')"><span>üî•</span>Incendio</button>
        <button onclick="abrirModalAvisoCustom()" style="background: var(--primary-dim); color: var(--primary); border-color: transparent;"><span>üì¢</span>Mensaje Libre</button>
      </div>
      <button class="btn-primary" style="background: var(--danger); height: 60px; font-size: 20px; margin-top: 10px;" onclick="window.location.href='tel:911'">üìû LLAMAR 911</button>
    </div>
  </div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyCD5Ji6o5t4HQo_6Hpj33Sz3PzzuH0JF9Y", authDomain: "app-vendedores-inteligente.firebaseapp.com", projectId: "app-vendedores-inteligente", storageBucket: "app-vendedores-inteligente.firebasestorage.app", messagingSenderId: "583313989429", appId: "1:583313989429:web:2d3663e547b609e211367c" };
    const VAPID_KEY = "BN480IhH70femCH6611oE699tLXFGYbS4MWcTbcEMbOUkR0vIwxXPrzTjhJEB9JcizJxqu4xs91-bQsal1_Hi8o";
    const API_URL = 'https://appseguridad.santamariapablodaniel.workers.dev/';

    function cambiarTema(tema) {
      document.documentElement.setAttribute('data-theme', tema);
      localStorage.setItem('temaVecinal', tema);
      document.getElementById('theme-color-meta').setAttribute('content', tema === 'oscuro' ? '#000000' : (tema === 'duotono' ? '#111827' : '#f2f2f7'));
      document.querySelectorAll('.theme-selector button').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-tema-' + tema)?.classList.add('active');
    }
    cambiarTema(localStorage.getItem('temaVecinal') || 'claro');

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    let userActual = null, intEstado = null, intGarita = null, intHistorial = null, idPendiente = null, audioContexto = null;
    let alertasNotificadas = new Set(), alarmaReintento = null, swRegistration = null, motivoAlertaActual = "", tipoAlertaActual = null; 
    let interaccionUsuario = false; // Memoria de interacci√≥n para audio

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { 
        navigator.serviceWorker.register('./firebase-messaging-sw.js').then(r => swRegistration = r);
        const idGuardado = localStorage.getItem('idVecinal');
        if (idGuardado) iniciarSesion(idGuardado); else mostrar('vista-login');
      });
    } else mostrar('vista-login');

    // ==========================================
    // INICIALIZACI√ìN INVISIBLE DE AUDIO Y PUSH
    // ==========================================
    function chequearEstadoGuardia() {
       const btn = document.getElementById('btn-habilitar-push');
       if (!btn || !userActual || userActual.rol.toUpperCase() !== 'GUARDIA') return;
       
       if (interaccionUsuario && Notification.permission === 'granted') {
           btn.style.display = 'none';
       } else {
           btn.style.display = 'block';
           if (!interaccionUsuario) {
               btn.innerText = "‚ö†Ô∏è Tocar aqu√≠ para activar Sirena";
               btn.className = "btn-danger-garita";
           } else {
               btn.innerText = "üîî Activar Notificaciones";
               btn.className = "btn-primary";
           }
       }
    }

    function inicializarAudio() {
       if (interaccionUsuario) return;
       if (!audioContexto) audioContexto = new (window.AudioContext || window.webkitAudioContext)();
       if (audioContexto.state === 'suspended') audioContexto.resume();
       
       if (audioContexto.state === 'running') {
           interaccionUsuario = true;
           chequearEstadoGuardia();
       }
    }

    // El simple hecho de tocar la pantalla en cualquier momento desbloquea el sonido
    document.addEventListener('click', inicializarAudio);
    document.addEventListener('touchstart', inicializarAudio, {passive: true});

    function habilitarNotificacionesGuardia() {
       inicializarAudio();
       if (Notification.permission !== 'granted') {
           Notification.requestPermission().then(permission => { 
               if (permission === 'granted') obtenerYGuardarToken();
               chequearEstadoGuardia();
           });
       }
    }

    async function api(accion, payload = {}) {
      try { return await (await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accion, payload }) })).json(); } 
      catch (e) { return { error: 'Error de red.' }; }
    }

    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => { v.style.display = 'none'; v.classList.remove('vista-activa'); });
      document.getElementById('loader').style.display = 'none';
      if(id) { const el = document.getElementById(id); el.style.display = 'flex'; setTimeout(() => el.classList.add('vista-activa'), 10); }
    }

    function chequearPin(input) { if (input.value.length === 4) { input.blur(); iniciarSesion(); } }

    function mostrarLoader(texto = "Conectando...") {
      document.getElementById('loader-text').innerText = texto;
      document.getElementById('loader').style.display = 'flex';
    }

    function ocultarLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    async function iniciarSesion(autoId = null) {
      const inputEl = document.getElementById('inputId');
      const id = autoId || inputEl.value;
      if(!id) return;
      
      mostrarLoader("Iniciando sesi√≥n...");
      const res = await api('login', { id });
      ocultarLoader();
      
      if(res.error) {
        if(autoId) localStorage.removeItem('idVecinal');
        document.getElementById('login-error').innerText = res.error; inputEl.value = ''; mostrar('vista-login');
      } else {
        userActual = res; localStorage.setItem('idVecinal', id);
        
        // Si las notificaciones ya estaban habilitadas antes, renovamos el token silenciosamente
        if (Notification.permission === 'granted') obtenerYGuardarToken();

        if(res.rol.toUpperCase() === 'GUARDIA') {
          mostrar('vista-garita'); 
          chequearEstadoGuardia();
          loopGarita(); 
        } else {
          document.getElementById('vecino-nombre').innerText = "Hola, " + res.nombre;
          document.getElementById('vecino-domicilio').innerHTML = "üìç " + res.domicilio;
          mostrar('vista-vecino'); configurarSOS(); cargarHistorial();
          if(intHistorial) clearInterval(intHistorial); intHistorial = setInterval(cargarHistorial, 10000);
          if (Notification.permission !== "granted") document.getElementById('modal-permisos').style.display = 'flex';
        }
      }
    }

    function cerrarSesion() { 
      localStorage.removeItem('idVecinal'); if(intHistorial) clearInterval(intHistorial); if(intEstado) clearInterval(intEstado); if(intGarita) clearInterval(intGarita); location.reload(); 
    }

    function concederPermisosVecino() {
      inicializarAudio(); // Aseguramos que el click activa el audio
      if(navigator.geolocation) navigator.geolocation.getCurrentPosition(()=>{}, ()=>{});
      Notification.requestPermission().then(permission => { if (permission === 'granted') obtenerYGuardarToken(); });
      document.getElementById('modal-permisos').style.display = 'none';
    }

    function obtenerYGuardarToken() {
      if (!swRegistration) { setTimeout(obtenerYGuardarToken, 1000); return; }
      messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: swRegistration }).then(token => { if(token) api('guardarToken', { idUsuario: userActual.id, token }); });
    }

    function mostrarToastExito(mensaje) {
      const toast = document.getElementById('toast-exito'); toast.innerText = mensaje; toast.classList.add('toast-show'); setTimeout(() => toast.classList.remove('toast-show'), 3000);
    }

    function cerrarModalAlerta() { document.getElementById('modal-alerta').style.display = 'none'; }

    function registrarLlegada() {
      tipoAlertaActual = 'LLEGADA';
      document.getElementById('mensaje-estado').className = ''; 
      document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--text-sec);">Obteniendo GPS...</span>';
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude), 
            () => procesarAviso('LLEGADA', null, null), 
            { timeout: 5000 }
        );
      } else procesarAviso('LLEGADA', null, null);
    }

    // ==========================================
    // L√ìGICA DE PROCESAMIENTO
    // ==========================================
    async function procesarAviso(tipo, lat, lng) {
      tipoAlertaActual = tipo; 
      if(navigator.vibrate) navigator.vibrate(50);
      try {
        const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
        if(res.error) {
          let errorMsg = res.error;
          if (errorMsg.includes('lejos')) {
              errorMsg = "EST√ÅS MUY LEJOS DEL RADIO PERMITIDO. SOLO SE PUEDE AVISAR A LA GARITA DENTRO DE UN RADIO DE 1KM PARA QUE EST√âN ATENTOS A TU INGRESO AL DOMICILIO.";
          }
          document.getElementById('mensaje-estado').innerHTML = `<div style="background: var(--danger-dark); color: white; padding: 15px; border-radius: 12px; font-size: 14px; line-height: 1.4; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">‚ö†Ô∏è ${errorMsg}</div>`;
        } else {
          document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--primary)">‚è≥ ${res.mensaje}</span>`;
          if (tipo === 'LLEGADA' || tipo === 'SOS') {
            idPendiente = res.idAviso;
            if(intEstado) clearInterval(intEstado);
            intEstado = setInterval(chequearConfirmacion, 2000); 
          }
        }
        return true;
      } catch(e) { return false; }
    }

    // ==========================================
    // L√ìGICA SOS ROBUSTA Y GLOBAL
    // ==========================================
    function bloquearBotonSOS() {
      const btn = document.getElementById('btn-sos'); btn.classList.add('sos-bloqueado'); 
      btn.innerHTML = '<span style="font-size:32px">ENVIADO</span>'; 
    }

    function configurarSOS() {
      const btn = document.getElementById('btn-sos'), barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;
      const reset = () => { if(btn.classList.contains('sos-bloqueado')) return; clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      
      const press = (e) => {
        if(btn.classList.contains('sos-bloqueado')) return;
        reset();
        if(navigator.vibrate) navigator.vibrate(20);
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        
        timer = setTimeout(async () => {
          clearInterval(iterador); 
          if(navigator.vibrate) navigator.vibrate([500, 200, 500]); 
          bloquearBotonSOS();
          
          mostrarLoader("Emitiendo Alerta Global...");

          // 1. Obtener GPS r√°pidamente
          let lat = null, lng = null;
          if (navigator.geolocation) {
              try {
                  const pos = await new Promise((resolve, reject) => {
                      navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 4000 });
                  });
                  lat = pos.coords.latitude;
                  lng = pos.coords.longitude;
              } catch (err) { console.log("GPS Timeout o Denegado"); }
          }

          // 2. Registrar en Garita
          await procesarAviso('SOS', lat, lng);

          // 3. Notificar a TODOS los vecinos mediante Push
          await api('alertaGarita', { motivo: `üö® EMERGENCIA EN DOMICILIO: ${userActual.domicilio} (${userActual.nombre})` });
          
          ocultarLoader();

          // 4. Abrir WhatsApp al grupo vecinal
          const link = (lat && lng) ? `https://maps.google.com/?q=${lat},${lng}` : 'Sin GPS.';
          const txt = `üö® *EMERGENCIA VECINAL* üö®\n\nSoy ${userActual.nombre}\nDom: ${userActual.domicilio}\n\n¬°NECESITO AYUDA INMEDIATA! Por favor, llamen al 911.\nUbicaci√≥n: ${link}`;
          window.location.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
        }, 2000);
      };
      
      btn.addEventListener('touchstart', press, {passive: true}); btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', reset); btn.addEventListener('mouseleave', reset);
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      const elEstado = document.getElementById('mensaje-estado');
      if(res.estado === 'CONFIRMADO') {
        if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
        if(tipoAlertaActual === 'SOS') {
           elEstado.className = 'estado-respuesta-sos'; 
           elEstado.innerHTML = '<div>üëÆ <b>¬°AYUDA EN CAMINO!</b></div><div style="font-size:14px; margin-top:5px;">Voy a llamar al 911 ahora y me acerco a la puerta de tu casa.</div>';
        } else {
           elEstado.className = '';
           elEstado.innerHTML = '<span style="color:var(--success); font-size:18px;">‚úÖ ¬°Visto por Garita!</span><br><span style="font-size:13px; color:var(--text-sec)">Puedes ingresar.</span>';
        }
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        elEstado.innerHTML = '<span style="color:var(--text-sec)">‚è≥ Aviso finalizado sin confirmaci√≥n.</span>'; clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      document.getElementById('lista-historial').innerHTML = datos.length ? datos.map(d => `<div class="historial-item"><span>${d.fecha}</span><span>${d.estado}</span></div>`).join('') : '<p style="text-align:center; padding:20px; color:var(--text-sec);">Sin registros recientes.</p>';
    }

    // ==========================================
    // GARITA Y MENSAJE PERSONALIZADO
    // ==========================================
    function abrirModalConfirmacion(motivo) {
      motivoAlertaActual = motivo; document.getElementById('texto-motivo-alerta').innerText = `"${motivo}"`; document.getElementById('modal-confirmacion').style.display = 'flex';
    }
    function cerrarModalConfirmacion() { document.getElementById('modal-confirmacion').style.display = 'none'; motivoAlertaActual = ""; }
    
    // Modal para el guardia para escribir MENSAJE LIBRE a los vecinos
    function abrirModalAvisoCustom() { document.getElementById('input-aviso-custom').value = ""; document.getElementById('modal-aviso-custom').style.display = 'flex'; }
    function cerrarModalAvisoCustom() { document.getElementById('modal-aviso-custom').style.display = 'none'; }
    function confirmarAvisoCustom() { const mensaje = document.getElementById('input-aviso-custom').value.trim(); if (!mensaje) return; cerrarModalAvisoCustom(); abrirModalConfirmacion(mensaje); }

    document.getElementById('btn-ejecutar-alerta').addEventListener('click', async () => {
      if(!motivoAlertaActual) return;
      const motivo = motivoAlertaActual; cerrarModalConfirmacion();
      
      mostrarLoader("Enviando Alerta...");
      await api('alertaGarita', { motivo: motivo }); 
      ocultarLoader();
      
      mostrarToastExito("‚úÖ Alerta enviada a todos"); actualizarGarita();
    });

    function emitirSonidoAlarma(esSOS) {
      if(!audioContexto) return;
      if(navigator.vibrate) navigator.vibrate(esSOS ? [500,200,500,200,500] : [300, 200, 300]);
      const osc = audioContexto.createOscillator(), gain = audioContexto.createGain();
      osc.type = esSOS ? 'sawtooth' : 'sine';
      osc.frequency.setValueAtTime(esSOS ? 880 : 660, audioContexto.currentTime);
      if(esSOS) osc.frequency.exponentialRampToValueAtTime(440, audioContexto.currentTime + 0.5);
      osc.connect(gain); gain.connect(audioContexto.destination);
      osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioContexto.currentTime + 1); osc.stop(audioContexto.currentTime + 1);
    }

    function loopGarita() { actualizarGarita(); intGarita = setInterval(actualizarGarita, 2500); }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos'), div = document.getElementById('lista-avisos');
      
      // Manejo de apagado de alarma persistente
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-sec); opacity:0.6;"><span style="font-size:40px; margin-bottom:10px;">üõ°Ô∏è</span>Sin novedades</div>';
        if(alarmaReintento) { clearInterval(alarmaReintento); alarmaReintento = null; }
        return;
      }

      let hayEmergencia = false, hayPendientesNuevos = false;
      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        if(!alertasNotificadas.has(a.id)) { alertasNotificadas.add(a.id); emitirSonidoAlarma(a.tipo === 'SOS'); }
        hayPendientesNuevos = true;
        return `<div class="tarjeta ${a.tipo === 'SOS' ? 'sos-urgente' : ''}">
          <div style="width:100%">
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <h3 style="margin:0; font-size: ${a.tipo === 'SOS' ? '24px' : '18px'}; color: ${a.tipo === 'SOS' ? 'var(--danger)' : 'var(--primary)'}; font-weight: 900; text-transform: uppercase;">${a.tipo === 'SOS' ? 'üö® SOS EMERGENCIA üö®' : 'üöó LLEGANDO'}</h3>
               <span style="font-size:14px; font-weight:bold; color:${a.tipo === 'SOS' ? 'var(--danger)' : 'var(--text-sec)'};">Hace ${a.tiempo} min</span>
            </div>
            <div style="margin: 15px 0; padding: 10px; background: ${a.tipo === 'SOS' ? 'rgba(220,38,38,0.1)' : 'var(--bg-body)'}; border-radius: 12px;">
                <p style="font-size:24px; margin: 0 0 5px 0; font-weight: 900; color: var(--text-main);">${a.domicilio}</p>
                <p style="font-size: 16px; margin:0; color: var(--text-sec); font-weight: 600;">${a.nombre}</p>
            </div>
            <button class="${a.tipo === 'SOS' ? 'btn-danger-garita' : 'btn-success'}" style="width:100%; height:55px; font-size:18px; text-transform:uppercase; font-weight:800;" onclick="confirmarGarita('${a.id}')">
                ${a.tipo === 'SOS' ? 'CONFIRMAR EMERGENCIA' : 'CONFIRMAR VISTA'}
            </button>
          </div>
        </div>`;
      }).join('');
      
      // PERSISTENCIA: Suena cada 15 segs si hay un aviso colgado sin confirmar.
      if(hayPendientesNuevos && !alarmaReintento) {
        alarmaReintento = setInterval(() => { emitirSonidoAlarma(hayEmergencia); }, 15000);
      }
    }

    async function confirmarGarita(id) {
      if(navigator.vibrate) navigator.vibrate(50);
      mostrarLoader("Confirmando vista...");
      await api('confirmarAviso', { idAviso: id });
      ocultarLoader();
      actualizarGarita();
    }

    messaging.onMessage((payload) => {
      emitirSonidoAlarma(true);
      if(userActual && userActual.rol.toUpperCase() === 'VECINO') {
         document.getElementById('texto-alerta-recibida').innerText = payload.notification.body;
         document.getElementById('modal-alerta').style.display = 'flex';
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>App Vecinal</title>
  
  <!-- Manifest para instalar como App (PWA) -->
  <link rel="manifest" href="manifest.json">
  
  <style>
    /* Estilos Modernos y Adaptativos */
    :root { 
      --primary: #0056b3; 
      --success: #28a745; 
      --danger: #dc3545; 
      --dark: #212529; 
      --light: #f8f9fa; 
      --bg-color: #e9ecef;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0; 
      padding: 20px; 
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: var(--dark);
    }

    .container { 
      width: 100%;
      max-width: 450px; 
      background: white; 
      padding: 30px 20px; 
      border-radius: 16px; 
      box-shadow: 0 10px 20px rgba(0,0,0,0.05); 
      text-align: center;
      box-sizing: border-box;
    }

    h2 { margin-top: 0; font-size: 24px; color: var(--primary); }
    h3 { margin-bottom: 5px; }

    input { 
      width: 100%; 
      padding: 15px; 
      margin: 15px 0; 
      border: 2px solid #ddd; 
      border-radius: 10px; 
      font-size: 18px; 
      text-align: center; 
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus { border-color: var(--primary); outline: none; }

    button { 
      width: 100%; 
      padding: 18px; 
      margin: 10px 0; 
      border: none; 
      border-radius: 12px; 
      font-size: 18px; 
      font-weight: bold; 
      color: white; 
      cursor: pointer; 
      transition: transform 0.1s, opacity 0.2s; 
      box-sizing: border-box;
    }
    button:active { transform: scale(0.96); opacity: 0.9; }
    
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); height: 100px; font-size: 24px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
    .btn-danger { background: var(--danger); height: 90px; font-size: 20px; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
    .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 12px; font-size: 16px;}
    
    /* Vistas (Manejo de "Dos apps en una") */
    .vista { display: none; animation: fadeIn 0.3s ease; }
    #vista-login { display: block; } /* Solo se ve el login al principio */
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Historial */
    .historial-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 15px; }
    .historial-item:last-child { border-bottom: none; }
    
    /* M√≥dulo Garita (Ultra simple, tarjetas grandes) */
    .tarjeta { border: 3px solid var(--primary); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: left; background: #fff; }
    .tarjeta.sos { border-color: var(--danger); background: #fff0f0; }
    .acciones-garita { display: flex; gap: 10px; flex-direction: column; margin-top: 15px; }
    .acciones-garita button { margin: 0; height: 60px; }
    
    .rojo { color: var(--danger); }
    
    #loader { display: none; font-weight: bold; color: var(--primary); margin: 20px 0; font-size: 18px; }
    
    /* Bot√≥n SOS con Barra de Progreso */
    .sos-container { position: relative; width: 100%; overflow: hidden; border-radius: 12px; margin-top: 20px; }
    #sos-progress { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(0,0,0,0.3); width: 0%; pointer-events: none; transition: width 0.1s linear;}
  </style>
</head>
<body>

  <!-- ===============================
       PANTALLA 1: INGRESO
       =============================== -->
  <div class="container vista" id="vista-login">
    <h2>Seguridad Vecinal</h2>
    <p style="color: #666; margin-bottom: 25px;">Ingres√° el DNI o ID proporcionado por la administraci√≥n.</p>
    
    <input type="number" id="inputId" placeholder="Ej: 1234">
    <button class="btn-primary" onclick="iniciarSesion()">Ingresar</button>
    
    <div id="login-error" class="rojo" style="margin-top: 15px; font-weight: bold;"></div>
  </div>

  <!-- ===============================
       PANTALLA 2: VECINO
       =============================== -->
  <div class="container vista" id="vista-vecino">
    <h2 id="vecino-nombre" style="font-size: 28px; margin-bottom: 20px;">Vecino</h2>
    
    <!-- Bot√≥n Principal -->
    <button class="btn-success" onclick="registrarLlegada()">üöó ESTOY LLEGANDO</button>
    <div id="mensaje-estado" style="min-height: 24px; margin: 15px 0; font-weight: bold; font-size: 18px;"></div>
    
    <!-- Bot√≥n SOS (Requiere mantener pulsado) -->
    <div class="sos-container">
      <button class="btn-danger" id="btn-sos">üö® EMERGENCIA (Mantener)</button>
      <div id="sos-progress"></div>
    </div>

    <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

    <!-- Privacidad: Solo ve su historial -->
    <h3 style="text-align: left; font-size: 16px; color: #666;">Mi √∫ltimos avisos</h3>
    <button class="btn-outline" onclick="cargarHistorial()" style="margin-top: 5px;">Actualizar historial</button>
    <div id="lista-historial" style="text-align: left; margin-top: 15px;">
      <p style="text-align: center; color: #999; font-size: 14px;">Toca actualizar para ver tus registros.</p>
    </div>
  </div>

  <!-- ===============================
       PANTALLA 3: GARITA (Operarios)
       =============================== -->
  <div class="container vista" id="vista-garita">
    <h2>CENTRAL DE ALERTAS</h2>
    <p style="color: #666;">Viendo avisos en tiempo real</p>
    
    <div id="lista-avisos" style="margin-top: 20px;">
      <!-- Ac√° aparecen los avisos gigantes -->
      Consultando...
    </div>
    
    <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">
    <button class="btn-danger" style="height: 70px;" onclick="window.location.href='tel:911'">üìû LLAMAR AL 911</button>
  </div>

  <div id="loader">Conectando al servidor... ‚è≥</div>

  <script>
    // --- 1. CONFIGURACI√ìN DEL WORKER DE CLOUDFLARE ---
    // ¬°IMPORTANTE! Reemplaz√° esta URL por la tuya de Cloudflare (la que termina en .workers.dev)
    const API_URL = 'https://TU-WORKER.TU-USUARIO.workers.dev';
    
    let userActual = null;
    let intEstado = null; // Monitorea si la garita confirm√≥
    let intGarita = null; // Hace que la garita actualice sola
    let idPendiente = null;

    // Registra el Service Worker para la PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW no registrado (normal en desarrollo):', err));
      });
    }

    // --- 2. COMUNICACI√ìN CON EL SERVIDOR ---
    async function api(accion, payload = {}) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ accion, payload })
        });
        return await res.json();
      } catch (e) {
        return { error: 'Error de red. Verifique su internet.' };
      }
    }

    // Cambia entre las pantallas (Login, Vecino, Garita)
    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      document.getElementById('loader').style.display = 'none';
      if(id) document.getElementById(id).style.display = 'block';
    }

    // --- 3. L√ìGICA DE LOGIN ---
    async function iniciarSesion() {
      const id = document.getElementById('inputId').value;
      if(!id) return;
      
      mostrar(''); // Oculta todo
      document.getElementById('loader').style.display = 'block';
      
      const res = await api('login', { id });
      document.getElementById('loader').style.display = 'none';
      
      if(res.error) {
        document.getElementById('login-error').innerText = res.error;
        mostrar('vista-login');
      } else {
        userActual = res;
        
        // ¬°LA MAGIA DE LAS "DOS APPS EN UNA"!
        if(res.rol.toUpperCase() === 'GUARDIA') {
          mostrar('vista-garita');
          loopGarita(); // Prende el motor de la garita
        } else {
          document.getElementById('vecino-nombre').innerText = "Hola, " + res.nombre;
          mostrar('vista-vecino');
          configurarSOS(); // Activa el bot√≥n de emergencia
        }
      }
    }

    // --- 4. FUNCIONES EXCLUSIVAS DEL VECINO ---
    function registrarLlegada() {
      document.getElementById('mensaje-estado').innerHTML = '<span style="color:#666;">Ubicando GPS...</span>';
      
      // Intentar sacar ubicaci√≥n para validar la distancia (1km)
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude),
          err => procesarAviso('LLEGADA', null, null), // Si falla el GPS, intenta avisar igual
          { timeout: 5000, enableHighAccuracy: true }
        );
      } else {
        procesarAviso('LLEGADA', null, null);
      }
    }

    async function procesarAviso(tipo, lat, lng) {
      const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
      
      if(res.error) {
        document.getElementById('mensaje-estado').innerHTML = `<span class="rojo">‚ö†Ô∏è ${res.error}</span>`;
      } else {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--primary)">${res.mensaje}</span>`;
        
        if (tipo === 'LLEGADA') {
          idPendiente = res.idAviso;
          if(intEstado) clearInterval(intEstado);
          // Arranca a preguntarle al servidor si el guardia ya toc√≥ confirmar
          intEstado = setInterval(chequearConfirmacion, 5000); 
        } else if (tipo === 'SOS') {
          // Si es SOS, abre el WhatsApp del grupo con la ubicaci√≥n exacta
          const link = (lat && lng) ? `https://maps.google.com/?q=${lat},${lng}` : 'Ubicaci√≥n desactivada en celular.';
          const txt = `üö® *EMERGENCIA VECINAL* üö®\n\nSoy ${userActual.nombre}\nDom: ${userActual.domicilio}\nUbicaci√≥n actual: ${link}`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
        }
      }
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      if(res.estado === 'CONFIRMADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--success)">‚úÖ Garita te vio. Avanz√°.</span>';
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span class="rojo">‚ùå El aviso expir√≥ (10 min).</span>';
        clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      document.getElementById('lista-historial').innerHTML = '<p>Cargando registros...</p>';
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      let html = datos.length 
        ? datos.map(d => `<div class="historial-item"><span>${d.fecha}</span><b>${d.estado}</b></div>`).join('') 
        : '<p style="color:#666; font-size:14px;">No hiciste avisos recientes.</p>';
      document.getElementById('lista-historial').innerHTML = html;
    }

    // Bot√≥n SOS Anti-Falsas Alarmas (Mantener presionado 2 segundos)
    function configurarSOS() {
      const btn = document.getElementById('btn-sos');
      const barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;

      const reset = () => { clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      
      const press = (e) => {
        e.preventDefault(); reset();
        
        // Rellena la barra
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        
        // Si llega a 2 segundos, dispara!
        timer = setTimeout(() => {
          clearInterval(iterador); 
          if(navigator.vibrate) navigator.vibrate([300, 100, 300]); // Hace vibrar el celu
          
          if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              p => procesarAviso('SOS', p.coords.latitude, p.coords.longitude), 
              e => procesarAviso('SOS', null, null),
              { timeout: 5000 }
            );
          } else {
             procesarAviso('SOS', null, null);
          }
        }, 2000);
      };
      
      btn.addEventListener('touchstart', press, {passive: false});
      btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press);
      btn.addEventListener('mouseup', reset);
      btn.addEventListener('mouseleave', reset);
    }

    // --- 5. FUNCIONES EXCLUSIVAS DE LA GARITA ---
    // (Cero escritura, operarios sin conocimientos)
    function loopGarita() {
      actualizarGarita();
      intGarita = setInterval(actualizarGarita, 5000); // Consulta la DB cada 5 segundos
    }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos');
      const div = document.getElementById('lista-avisos');
      
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<div style="padding:40px 0; color:#aaa; font-weight:bold; font-size:20px;">Sin alertas activas.</div>';
        return;
      }

      let hayEmergencia = false;
      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        let icono = a.tipo === 'SOS' ? 'üö® EMERGENCIA' : 'üöó LLEGA VECINO';
        return `
        <div class="tarjeta ${a.tipo === 'SOS' ? 'sos' : ''}">
          <h3 style="margin:0">${icono}</h3>
          <p style="font-size:18px; margin: 10px 0;">
            <b>${a.nombre}</b><br>
            üìç ${a.domicilio}<br>
            <span style="color:#666; font-size:14px;">Ingres√≥ hace ${a.tiempo} min</span>
          </p>
          <div class="acciones-garita">
            <button class="btn-success" onclick="confirmarGarita('${a.id}')">CONFIRMAR VISTA</button>
          </div>
        </div>`;
      }).join('');
      
      // Si hay emergencia suena alarma (vibraci√≥n en celular de garita)
      if(hayEmergencia && navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
    }

    async function confirmarGarita(id) {
      // El guardia toc√≥ confirmar, avisa al servidor
      document.getElementById('lista-avisos').innerHTML = '<p>Confirmando...</p>';
      await api('confirmarAviso', { idAviso: id });
      actualizarGarita(); // Refresca pantalla
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Alerta Vecinal</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --dark: #343a40; --light: #f8f9fa; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--light); margin: 0; padding: 20px; text-align: center; color: var(--dark); }
    .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; text-align: center; }
    button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; color: white; cursor: pointer; transition: 0.2s; }
    button:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); height: 90px; font-size: 22px; }
    .btn-danger { background: var(--danger); height: 80px; font-size: 20px; }
    .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
    
    .vista { display: none; }
    #vista-login { display: block; }
    
    /* Historial */
    .historial-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    
    /* Garita */
    .tarjeta { border: 2px solid var(--primary); border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; background: #fff; }
    .tarjeta.sos { border-color: var(--danger); background: #ffe6e6; }
    .acciones-garita { display: flex; gap: 10px; }
    .acciones-garita button { margin: 5px 0; font-size: 14px; height: 50px; }
    
    .rojo { color: var(--danger); }
    #loader { display: none; font-weight: bold; color: var(--primary); margin: 20px 0; }
    
    /* SOS Animaci√≥n */
    .sos-container { position: relative; width: 100%; overflow: hidden; border-radius: 8px; }
    #sos-progress { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(0,0,0,0.2); width: 0%; pointer-events: none; transition: width 0.1s linear;}
  </style>
</head>
<body>

  <div class="container vista" id="vista-login">
    <h2>Seguridad Vecinal</h2>
    <input type="number" id="inputId" placeholder="Ingres√° tu DNI o ID">
    <button class="btn-primary" onclick="iniciarSesion()">Ingresar</button>
    <div id="login-error" class="rojo"></div>
  </div>

  <div class="container vista" id="vista-vecino">
    <h2 id="vecino-nombre">Vecino</h2>
    <button class="btn-success" onclick="registrarLlegada()">üöó ESTOY LLEGANDO</button>
    <div id="mensaje-estado" style="min-height: 24px; margin: 10px 0; font-weight: bold;"></div>
    
    <div class="sos-container">
      <button class="btn-danger" id="btn-sos">üö® EMERGENCIA (Mantener)</button>
      <div id="sos-progress"></div>
    </div>

    <button class="btn-outline" onclick="cargarHistorial()" style="margin-top:20px; font-size: 14px; height: auto; padding: 10px;">Ver mi historial</button>
    <div id="lista-historial" style="text-align: left; margin-top: 10px;"></div>
  </div>

  <div class="container vista" id="vista-garita">
    <h2>GARITA - ALERTAS</h2>
    <div id="lista-avisos">Consultando...</div>
    <hr>
    <button class="btn-danger" onclick="window.location.href='tel:911'">üìû LLAMAR 911</button>
  </div>

  <div id="loader">Conectando al servidor... ‚è≥</div>

  <script>
    // --- REGISTRO SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW Registrado'))
          .catch(err => console.log('SW Error', err));
      });
    }

    // --- CONFIGURACI√ìN API ---
    // IMPORTANTE: Peg√° ac√° la URL que te dio Cloudflare Workers (termina en .workers.dev)
    const API_URL = 'https://appseguridad.santamariapablodaniel.workers.dev/';
    
    let userActual = null;
    let intEstado = null;
    let intGarita = null;
    let idPendiente = null;

    // --- N√öCLEO FETCH (Limpio gracias al Worker) ---
    async function api(accion, payload = {}) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ accion, payload })
        });
        return await res.json();
      } catch (e) {
        return { error: 'Error de conexi√≥n. Verifica internet.' };
      }
    }

    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      document.getElementById('loader').style.display = 'none';
      if(id) document.getElementById(id).style.display = 'block';
    }

    // --- L√ìGICA GENERAL ---
    async function iniciarSesion() {
      const id = document.getElementById('inputId').value;
      if(!id) return;
      mostrar(''); document.getElementById('loader').style.display = 'block';
      
      const res = await api('login', { id });
      document.getElementById('loader').style.display = 'none';
      
      if(res.error) {
        document.getElementById('login-error').innerText = res.error;
        mostrar('vista-login');
      } else {
        userActual = res;
        if(res.rol === 'GUARDIA') {
          mostrar('vista-garita');
          loopGarita();
        } else {
          document.getElementById('vecino-nombre').innerText = res.nombre;
          mostrar('vista-vecino');
          configurarSOS();
        }
      }
    }

    // --- VECINO ---
    function registrarLlegada() {
      document.getElementById('mensaje-estado').innerHTML = 'Calculando ubicaci√≥n...';
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude),
          err => procesarAviso('LLEGADA', null, null), // Env√≠a sin ubicaci√≥n si falla
          { timeout: 5000 }
        );
      } else {
        procesarAviso('LLEGADA', null, null);
      }
    }

    async function procesarAviso(tipo, lat, lng) {
      const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
      if(res.error) {
        document.getElementById('mensaje-estado').innerHTML = `<span class="rojo">${res.error}</span>`;
      } else {
        document.getElementById('mensaje-estado').innerText = res.mensaje;
        if (tipo === 'LLEGADA') {
          idPendiente = res.idAviso;
          if(intEstado) clearInterval(intEstado);
          intEstado = setInterval(chequearConfirmacion, 5000);
        } else if (tipo === 'SOS') {
          // Genera el link correcto de Google Maps
          const linkUbicacion = (lat && lng) ? `https://maps.google.com/?q=${lat},${lng}` : 'Ubicaci√≥n GPS no disponible';
          const txt = `üö® *EMERGENCIA* üö®\nSoy ${userActual.nombre}\nDom: ${userActual.domicilio}\nUbicaci√≥n: ${linkUbicacion}`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
        }
      }
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      if(res.estado === 'CONFIRMADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--success)">Garita atento ‚úÖ</span>';
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span class="rojo">Aviso expirado (Sin confirmaci√≥n)</span>';
        clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      document.getElementById('lista-historial').innerHTML = 'Cargando...';
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      let html = datos.length ? datos.map(d => `<div class="historial-item"><span>${d.fecha}</span><b>${d.estado}</b></div>`).join('') : '<p>Sin registros</p>';
      document.getElementById('lista-historial').innerHTML = html;
    }

    // Bot√≥n SOS Mantenido
    function configurarSOS() {
      const btn = document.getElementById('btn-sos');
      const barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;

      const reset = () => { clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      const press = (e) => {
        e.preventDefault(); reset();
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        timer = setTimeout(() => {
          clearInterval(iterador); navigator.vibrate?.([200,200,200]);
          navigator.geolocation?.getCurrentPosition(
            p => procesarAviso('SOS', p.coords.latitude, p.coords.longitude), 
            e => procesarAviso('SOS', null, null)
          );
        }, 2000);
      };
      
      btn.addEventListener('touchstart', press, {passive: false});
      btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press);
      btn.addEventListener('mouseup', reset);
      btn.addEventListener('mouseleave', reset);
    }

    // --- GARITA ---
    function loopGarita() {
      actualizarGarita();
      intGarita = setInterval(actualizarGarita, 5000);
    }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos');
      const div = document.getElementById('lista-avisos');
      
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<p style="color:gray; font-weight:bold;">Sin alertas activas.</p>';
        return;
      }

      let hayEmergencia = false;
      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        return `
        <div class="tarjeta ${a.tipo === 'SOS' ? 'sos' : ''}">
          <h3 style="margin:0">${a.tipo === 'SOS' ? 'üö® EMERGENCIA' : 'üöó LLEGA VECINO'}</h3>
          <p><b>${a.nombre}</b><br>${a.domicilio}<br><small>Hace ${a.tiempo} min</small></p>
          <div class="acciones-garita">
            <button class="btn-success" onclick="confirmarGarita('${a.id}')">CONFIRMAR</button>
            ${a.tipo === 'SOS' && a.telefono ? `<button class="btn-primary" onclick="window.location.href='tel:${a.telefono}'">WhatsApp / Llamar</button>` : ''}
          </div>
        </div>`;
      }).join('');
      
      if(hayEmergencia) navigator.vibrate?.([500,200,500]);
    }

    async function confirmarGarita(id) {
      await api('confirmarAviso', { idAviso: id });
      actualizarGarita();
    }
  </script>
</body>
</html>

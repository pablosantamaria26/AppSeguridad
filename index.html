<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
  <meta name="theme-color" content="#f0f2f5" id="theme-color-meta">
  <title>Alerta Vecinal</title>
  
  <!-- Fundamental para iPhone -->
  <link rel="apple-touch-icon" href="icono.png">
  <link rel="manifest" href="manifest.json">
  
  <!-- SDK de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

  <style>
    /* ==========================================
       VARIABLES DE TEMAS Y DISE√ëO
       ========================================== */
    :root { 
      --primary: #007aff; --success: #34c759; --danger: #ff3b30; 
      --dark: #1c1c1e; --gray: #8e8e93; --bg-color: #f2f2f7; 
      --card-bg: #ffffff; --warn: #ffcc00; --text-main: #1c1c1e;
      --input-bg: #fafafa; --border: #e5e5ea;
      --glass-blur: blur(0px);
      --bg-gradient: linear-gradient(135deg, #4b5563 0%, #e2e8f0 100%);
    }

    [data-theme="oscuro"] {
      --primary: #0a84ff; --success: #32d74b; --danger: #ff453a; 
      --dark: #ffffff; --gray: #98989d; --bg-color: #000000; 
      --card-bg: #1c1c1e; --warn: #ffd60a; --text-main: #ffffff;
      --input-bg: #2c2c2e; --border: #38383a;
      --glass-blur: blur(0px);
      --bg-gradient: linear-gradient(135deg, #09090b 0%, #27272a 100%);
    }

    [data-theme="duotono"] {
      --primary: #38bdf8; --success: #10b981; --danger: #f43f5e; 
      --dark: #ffffff; --gray: #cbd5e1; --bg-color: transparent; 
      --card-bg: rgba(15, 23, 42, 0.65); --warn: #fbbf24; --text-main: #f8fafc;
      --input-bg: rgba(255, 255, 255, 0.1); --border: rgba(255, 255, 255, 0.15);
      --glass-blur: blur(16px);
      --bg-gradient: linear-gradient(-45deg, #1e3a8a, #7e22ce, #0f172a, #be185d);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    html, body {
      height: 100%; width: 100%;
      overflow: hidden; margin: 0; padding: 0;
      touch-action: manipulation;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      background: var(--bg-gradient);
      background-attachment: fixed;
      display: flex; justify-content: center; align-items: center; 
      color: var(--text-main); 
      transition: background 0.4s ease, color 0.4s ease;
      overscroll-behavior: none;
    }

    body.tema-duotono-activo {
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    .container { 
      width: 92%; max-width: 420px; 
      max-height: 94vh;
      overflow-y: auto;
      background: var(--card-bg); 
      padding: 35px 25px; 
      border-radius: 28px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
      text-align: center; 
      transition: all 0.4s ease; 
      position: relative;
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--border);
      scrollbar-width: none;
    }
    .container::-webkit-scrollbar { display: none; }

    h2 { margin-top: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; color: var(--dark); }
    p { color: var(--gray); font-size: 15px; line-height: 1.5; }

    /* ESTILO PIN */
    .pin-input { 
      width: 100%; padding: 20px 0; margin: 25px 0; 
      border: 2px solid var(--border); border-radius: 20px; 
      font-size: 34px; font-weight: 800; text-align: center; 
      letter-spacing: 18px; text-indent: 18px; 
      font-family: monospace;
      background-color: var(--input-bg); color: var(--text-main); 
      transition: all 0.3s ease; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
    }
    .pin-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); }

    .custom-textarea {
      width: 100%; padding: 15px; margin: 0 auto 20px auto; 
      border-radius: 15px; border: 2px solid var(--border); 
      background: var(--input-bg); color: var(--text-main); 
      font-size: 16px; font-family: inherit; resize: none;
      display: block; box-sizing: border-box;
    }

    button { 
      width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 22px; 
      font-size: 19px; font-weight: 700; color: white; cursor: pointer; 
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: 0 6px 16px rgba(0,0,0,0.15); position: relative; overflow: hidden; 
    }
    button:active { transform: scale(0.95) translateY(2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    .btn-primary { background: var(--primary); box-shadow: 0 6px 20px rgba(0, 122, 255, 0.25); }
    .btn-success { background: linear-gradient(135deg, var(--success), #28a745); height: 110px; font-size: 24px; box-shadow: 0 10px 25px rgba(52, 199, 89, 0.35); }
    
    .btn-danger { background: linear-gradient(135deg, var(--danger), #d32f2f); height: 100px; font-size: 22px; box-shadow: 0 10px 25px rgba(255, 59, 48, 0.35); }
    
    /* BOT√ìN SOS BLOQUEADO */
    .sos-bloqueado { 
      background: #555 !important; 
      opacity: 0.7; 
      pointer-events: none; 
      transform: none !important; 
      box-shadow: none !important;
    }

    .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--border); padding: 14px; font-size: 15px; box-shadow: none; border-radius: 16px;}
    .btn-logout { background: transparent; color: var(--gray); box-shadow: none; font-size: 14px; padding: 10px; margin-top: 20px; text-decoration: underline; border-radius: 10px;}

    .vista { display: none; animation: fadeIn 0.4s ease-out; }
    #vista-login { display: block; } 
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

    .historial-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 15px; font-weight: 600; color: var(--dark);}
    .historial-item:last-child { border-bottom: none; }
    
    .tarjeta { border: none; border-radius: 20px; padding: 25px; margin-bottom: 20px; text-align: left; background: var(--input-bg); box-shadow: 0 8px 25px rgba(0,0,0,0.06); position: relative; overflow: hidden; }
    .tarjeta::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background: var(--primary); }
    .tarjeta.sos::before { background: var(--danger); }
    .tarjeta.sos { background: rgba(255, 59, 48, 0.08); animation: pulseAlert 2s infinite; }
    @keyframes pulseAlert { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

    #loader { display: none; font-weight: bold; color: var(--primary); margin: 20px 0; font-size: 18px; }
    .sos-container { position: relative; width: 100%; border-radius: 22px; margin-top: 20px; overflow: hidden; }
    #sos-progress { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(0,0,0,0.3); width: 0%; pointer-events: none; transition: width 0.1s linear;}

    #vista-garita.container { backdrop-filter: none; background: var(--card-bg); border: none; }
    .grid-botones { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
    .grid-botones button { padding: 15px 10px; height: 95px; font-size: 14px; margin: 0; background: var(--input-bg); color: var(--dark); border: 2px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 18px;}
    .grid-botones button span { font-size: 26px; display: block; margin-bottom: 5px; }

    .theme-selector { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
    .theme-selector button { padding: 12px; font-size: 12px; height: auto; margin: 0; border-radius: 14px; background: var(--input-bg); color: var(--text-main); border: 2px solid var(--border); box-shadow: none; font-weight: 600;}
    .theme-selector button.active { border-color: var(--primary); background: rgba(0, 122, 255, 0.1); color: var(--primary); }

    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); animation: fadeInModal 0.3s ease; }
    .modal-content { background: var(--card-bg); padding: 35px 30px; border-radius: 28px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid var(--border); }
    .modal-content h3 { margin-top: 0; color: var(--dark); font-size: 24px; margin-bottom: 12px; }
    .modal-content p { color: var(--gray); margin-bottom: 25px; font-size: 16px; line-height: 1.5; }

    .toast-notificacion { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 16px 28px; border-radius: 20px; font-weight: bold; font-size: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 2000; transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    .toast-show { top: 25px; }
  </style>
</head>
<body>

  <!-- MODAL PERMISOS -->
  <div id="modal-permisos" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 15px;">üìçüîî</div>
      <h3>Permisos Necesarios</h3>
      <p>Para que la garita sepa que est√°s cerca y puedas recibir alertas, necesitamos tu permiso de ubicaci√≥n y notificaciones.</p>
      <button class="btn-primary" onclick="concederPermisosVecino()">¬°Habilitar Todo!</button>
    </div>
  </div>

  <!-- MODAL CONFIRMAR ALERTA -->
  <div id="modal-confirmacion" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 10px;">‚ö†Ô∏è</div>
      <h3>¬øEnviar Alerta Global?</h3>
      <p id="texto-motivo-alerta" style="font-size: 18px; font-weight: bold; color: var(--danger); margin-bottom: 10px;"></p>
      <p>Esto har√° sonar los celulares de todos los vecinos.</p>
      <div style="display: flex; gap: 10px;">
        <button class="btn-outline" onclick="cerrarModalConfirmacion()" style="margin:0;">Cancelar</button>
        <button class="btn-danger" id="btn-ejecutar-alerta" style="margin:0;">S√≠, Enviar</button>
      </div>
    </div>
  </div>

  <!-- MODAL MENSAJE CUSTOM (GARITA) -->
  <div id="modal-aviso-custom" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 10px;">üì¢</div>
      <h3>Aviso General</h3>
      <p>Escrib√≠ el mensaje que recibir√°n todos los vecinos:</p>
      <textarea id="input-aviso-custom" class="custom-textarea" rows="3" placeholder="Ej: Calle 5 cortada..."></textarea>
      <div style="display: flex; gap: 10px;">
        <button class="btn-outline" onclick="cerrarModalAvisoCustom()" style="margin:0;">Cancelar</button>
        <button class="btn-primary" onclick="confirmarAvisoCustom()" style="margin:0;">Continuar</button>
      </div>
    </div>
  </div>

  <!-- MODAL ALERTA RECIBIDA -->
  <div id="modal-alerta" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 10px; animation: pulseAlert 1.5s infinite;">üö®</div>
      <h3 style="color: var(--danger);">ALERTA DE GARITA</h3>
      <p id="texto-alerta-recibida" style="font-size: 20px; font-weight: bold; color: var(--dark);"></p>
      <button class="btn-primary" onclick="cerrarModalAlerta()">Entendido</button>
    </div>
  </div>

  <div id="toast-exito" class="toast-notificacion">‚úÖ Operaci√≥n exitosa</div>

  <!-- VISTA LOGIN -->
  <div class="container vista" id="vista-login">
    <div style="font-size: 45px; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h2>Seguridad Vecinal</h2>
    <p>Ingres√° tu PIN de seguridad (4 d√≠gitos)</p>
    <input type="password" id="inputId" class="pin-input" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="chequearPin(this)">
    <div id="login-error" style="color: var(--danger); margin-top: 10px; font-weight: bold;"></div>
  </div>

  <!-- VISTA VECINO -->
  <div class="container vista" id="vista-vecino">
    <h2 id="vecino-nombre" style="font-size: 28px; margin-bottom: 5px; color: var(--primary);">Vecino</h2>
    <p id="vecino-domicilio" style="margin-bottom: 25px; font-weight: 600; color: var(--dark);"></p>
    
    <button class="btn-success" onclick="registrarLlegada()">üöó ESTOY LLEGANDO</button>
    <div id="mensaje-estado" style="min-height: 24px; margin: 15px 0; font-weight: bold; font-size: 18px;"></div>
    
    <div class="sos-container">
      <button class="btn-danger" id="btn-sos">üö® EMERGENCIA<br><small id="sos-instruccion" style="font-size: 14px; font-weight: 600; opacity: 0.9;">(Mantener presionado)</small></button>
      <div id="sos-progress"></div>
    </div>

    <hr style="border: 0; border-top: 2px dashed var(--border); margin: 35px 0 25px 0;">
    <button class="btn-outline" onclick="cargarHistorial()">‚Üª Actualizar historial</button>
    <div id="lista-historial" style="text-align: left; margin-top: 15px;"></div>

    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0 15px 0;">
    <div class="theme-selector">
      <button id="btn-tema-claro" onclick="cambiarTema('claro')">‚òÄÔ∏è Claro</button>
      <button id="btn-tema-oscuro" onclick="cambiarTema('oscuro')">üåô Oscuro</button>
      <button id="btn-tema-duotono" onclick="cambiarTema('duotono')">‚ú® Duo Tono</button>
    </div>
    <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </div>

  <!-- VISTA GARITA -->
  <div class="container vista" id="vista-garita">
    <h2>CENTRAL GARITA</h2>
    <button id="btn-habilitar-push" class="btn-primary" onclick="habilitarNotificaciones()" style="background:var(--warn); color:#000; box-shadow:none;">üîî Activar Alertas</button>
    <div id="lista-avisos" style="margin-top: 25px;"></div>
    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0;">
    <div class="grid-botones">
      <button onclick="abrirModalConfirmacion('Sospechoso merodeando')"><span>üïµÔ∏è‚Äç‚ôÇÔ∏è</span>Sospechoso</button>
      <button onclick="abrirModalConfirmacion('Veh√≠culo desconocido')"><span>üöò</span>Veh√≠culo Raro</button>
      <button onclick="abrirModalConfirmacion('Ruidos molestos detectados')"><span>üîä</span>Ruidos</button>
      <button onclick="abrirModalConfirmacion('Falla de suministro el√©ctrico/agua')"><span>‚ö†Ô∏è</span>Corte Luz/Agua</button>
      <button onclick="abrirModalConfirmacion('Incendio o humo detectado')"><span>üî•</span>Incendio</button>
      <button onclick="abrirModalAvisoCustom()"><span>üì¢</span>Aviso Gral</button>
    </div>
    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0;">
    <button class="btn-danger" style="height: 70px; font-size: 20px;" onclick="window.location.href='tel:911'">üìû LLAMAR 911</button>
    <button class="btn-logout" onclick="cerrarSesion()">Cerrar turno</button>
  </div>

  <div id="loader">Conectando... ‚è≥</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCD5Ji6o5t4HQo_6Hpj33Sz3PzzuH0JF9Y",
      authDomain: "app-vendedores-inteligente.firebaseapp.com",
      projectId: "app-vendedores-inteligente",
      storageBucket: "app-vendedores-inteligente.firebasestorage.app",
      messagingSenderId: "583313989429",
      appId: "1:583313989429:web:2d3663e547b609e211367c"
    };
    const VAPID_KEY = "BN480IhH70femCH6611oE699tLXFGYbS4MWcTbcEMbOUkR0vIwxXPrzTjhJEB9JcizJxqu4xs91-bQsal1_Hi8o";
    const API_URL = 'https://appseguridad.santamariapablodaniel.workers.dev/';

    function cambiarTema(tema) {
      document.documentElement.setAttribute('data-theme', tema);
      localStorage.setItem('temaVecinal', tema);
      const metaColor = document.getElementById('theme-color-meta');
      if(tema === 'oscuro') {
        metaColor.setAttribute('content', '#000000');
        document.body.classList.remove('tema-duotono-activo');
      } else if(tema === 'duotono') {
        metaColor.setAttribute('content', '#1e3a8a');
        document.body.classList.add('tema-duotono-activo');
      } else {
        metaColor.setAttribute('content', '#f2f2f7');
        document.body.classList.remove('tema-duotono-activo');
      }
      document.querySelectorAll('.theme-selector button').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-tema-' + tema)?.classList.add('active');
    }
    cambiarTema(localStorage.getItem('temaVecinal') || 'claro');

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    let userActual = null, intEstado = null, intGarita = null, idPendiente = null, audioContexto = null;
    let alertasNotificadas = new Set(), alarmaReintento = null, swRegistration = null, motivoAlertaActual = ""; 

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { 
        navigator.serviceWorker.register('./firebase-messaging-sw.js')
          .then(registration => { swRegistration = registration; })
          .catch(err => console.log('Error en SW:', err));
        const idGuardado = localStorage.getItem('idVecinal');
        if (idGuardado) iniciarSesion(idGuardado);
      });
    }

    async function api(accion, payload = {}) {
      try {
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accion, payload }) });
        return await res.json();
      } catch (e) { return { error: 'Error de red.' }; }
    }

    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      document.getElementById('loader').style.display = 'none';
      if(id) document.getElementById(id).style.display = 'block';
    }

    function chequearPin(input) {
      if (input.value.length === 4) { input.blur(); iniciarSesion(); }
    }

    async function iniciarSesion(autoId = null) {
      const inputEl = document.getElementById('inputId');
      const id = autoId || inputEl.value;
      if(!id) return;
      mostrar(''); document.getElementById('loader').style.display = 'block';
      const res = await api('login', { id });
      document.getElementById('loader').style.display = 'none';
      if(res.error) {
        if(autoId) localStorage.removeItem('idVecinal');
        document.getElementById('login-error').innerText = res.error;
        inputEl.value = '';
        mostrar('vista-login');
      } else {
        userActual = res;
        localStorage.setItem('idVecinal', id);
        if(res.rol.toUpperCase() === 'GUARDIA') {
          mostrar('vista-garita');
          document.getElementById('btn-habilitar-push').style.display = 'block';
          loopGarita(); 
        } else {
          document.getElementById('vecino-nombre').innerText = res.nombre;
          document.getElementById('vecino-domicilio').innerText = "üìç " + res.domicilio;
          mostrar('vista-vecino');
          configurarSOS(); 
          if (Notification.permission !== "granted") document.getElementById('modal-permisos').style.display = 'flex';
          else obtenerYGuardarToken();
        }
      }
    }

    function cerrarSesion() { localStorage.removeItem('idVecinal'); location.reload(); }

    function concederPermisosVecino() {
      audioContexto = new (window.AudioContext || window.webkitAudioContext)();
      if(navigator.geolocation) navigator.geolocation.getCurrentPosition(()=>{}, ()=>{});
      Notification.requestPermission().then(permission => { if (permission === 'granted') obtenerYGuardarToken(); });
      document.getElementById('modal-permisos').style.display = 'none';
    }

    function habilitarNotificaciones() {
      document.getElementById('btn-habilitar-push').style.display = 'none';
      audioContexto = new (window.AudioContext || window.webkitAudioContext)(); 
      Notification.requestPermission().then(permission => { if (permission === 'granted') obtenerYGuardarToken(); });
    }

    function obtenerYGuardarToken() {
      if (!swRegistration) { setTimeout(obtenerYGuardarToken, 1000); return; }
      messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: swRegistration })
        .then(currentToken => {
          if (currentToken) api('guardarToken', { idUsuario: userActual.id, token: currentToken }).then(() => mostrarToastExito("üîî Notificaciones Activas"));
        }).catch(err => console.error("Error token:", err));
    }

    function mostrarToastExito(mensaje) {
      const toast = document.getElementById('toast-exito');
      toast.innerText = mensaje;
      toast.classList.add('toast-show');
      setTimeout(() => toast.classList.remove('toast-show'), 3000);
    }

    function cerrarModalAlerta() { document.getElementById('modal-alerta').style.display = 'none'; }

    function registrarLlegada() {
      document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--gray);">Ubicando GPS...</span>';
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude),
          err => procesarAviso('LLEGADA', null, null), { timeout: 5000 }
        );
      } else procesarAviso('LLEGADA', null, null);
    }

    async function procesarAviso(tipo, lat, lng) {
      if(navigator.vibrate) navigator.vibrate(50);
      const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
      if(res.error) document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--danger)">‚ö†Ô∏è ${res.error}</span>`;
      else {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--primary)">‚è≥ ${res.mensaje}</span>`;
        if (tipo === 'LLEGADA') {
          idPendiente = res.idAviso;
          if(intEstado) clearInterval(intEstado);
          intEstado = setInterval(chequearConfirmacion, 5000); 
        } else if (tipo === 'SOS') {
          // MENSAJE DE WHATSAPP LIMPIO SIN GPS
          const txt = `üö® *EMERGENCIA VECINAL - ROBO EN PROCESO* üö®\n\nSoy ${userActual.nombre}\nTel: ${userActual.telefono || 'Sin registro'}\nDom: ${userActual.domicilio}\n\n¬°ESTOY SUFRIENDO UN ROBO! Por favor, llamen al 911 ahora mismo.`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
          
          // BLOQUEAR EL BOT√ìN F√çSICAMENTE
          bloquearBotonSOS();
        }
      }
    }

    function bloquearBotonSOS() {
      const btn = document.getElementById('btn-sos');
      btn.classList.add('sos-bloqueado');
      btn.innerHTML = 'üö® ALERTA ENVIADA';
      document.getElementById('sos-instruccion').innerText = '(Acci√≥n completada)';
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      if(res.estado === 'CONFIRMADO') {
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--success)">‚úÖ ¬°Visto por Garita!</span>';
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--danger)">‚ùå Aviso Expirado</span>';
        clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      document.getElementById('lista-historial').innerHTML = datos.length ? datos.map(d => `<div class="historial-item"><span>${d.fecha}</span><span>${d.estado}</span></div>`).join('') : '<p>Sin registros.</p>';
    }

    function configurarSOS() {
      const btn = document.getElementById('btn-sos'), barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;
      const reset = () => { if(btn.classList.contains('sos-bloqueado')) return; clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      const press = (e) => {
        if(btn.classList.contains('sos-bloqueado')) return;
        e.preventDefault(); reset();
        if(navigator.vibrate) navigator.vibrate(20);
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        timer = setTimeout(() => {
          clearInterval(iterador); 
          if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]); 
          // Ya no necesitamos enviar lat/lng al procesar el aviso SOS porque quitamos el link
          procesarAviso('SOS', null, null);
        }, 2000);
      };
      btn.addEventListener('touchstart', press, {passive: false}); btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', reset); btn.addEventListener('mouseleave', reset);
    }

    function abrirModalConfirmacion(motivo) {
      motivoAlertaActual = motivo;
      document.getElementById('texto-motivo-alerta').innerText = `"${motivo}"`;
      document.getElementById('modal-confirmacion').style.display = 'flex';
    }

    function cerrarModalConfirmacion() { document.getElementById('modal-confirmacion').style.display = 'none'; motivoAlertaActual = ""; }
    function abrirModalAvisoCustom() { document.getElementById('input-aviso-custom').value = ""; document.getElementById('modal-aviso-custom').style.display = 'flex'; }
    function cerrarModalAvisoCustom() { document.getElementById('modal-aviso-custom').style.display = 'none'; }

    function confirmarAvisoCustom() {
      const mensaje = document.getElementById('input-aviso-custom').value.trim();
      if (!mensaje) return;
      cerrarModalAvisoCustom();
      abrirModalConfirmacion(mensaje);
    }

    document.getElementById('btn-ejecutar-alerta').addEventListener('click', async () => {
      if(!motivoAlertaActual) return;
      const motivo = motivoAlertaActual;
      cerrarModalConfirmacion();
      const listaDiv = document.getElementById('lista-avisos');
      listaDiv.innerHTML = '<p>Enviando Alerta...</p>';
      await api('alertaGarita', { motivo: motivo });
      mostrarToastExito("‚úÖ Alerta enviada");
      actualizarGarita();
    });

    function emitirSonidoAlarma(esSOS) {
      if(!audioContexto) return;
      if(navigator.vibrate) navigator.vibrate(esSOS ? [500,200,500,200,500] : [300, 200, 300]);
      const osc = audioContexto.createOscillator(), gain = audioContexto.createGain();
      osc.type = esSOS ? 'sawtooth' : 'sine';
      osc.frequency.setValueAtTime(esSOS ? 880 : 660, audioContexto.currentTime);
      if(esSOS) osc.frequency.exponentialRampToValueAtTime(440, audioContexto.currentTime + 0.5);
      osc.connect(gain); gain.connect(audioContexto.destination);
      osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioContexto.currentTime + 1); osc.stop(audioContexto.currentTime + 1);
    }

    function loopGarita() { actualizarGarita(); intGarita = setInterval(actualizarGarita, 5000); }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos'), div = document.getElementById('lista-avisos');
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<div style="padding:50px 0; color:var(--gray); font-weight:600; font-size:18px;">‚úîÔ∏è Sin alertas pendientes.</div>';
        if(alarmaReintento) { clearInterval(alarmaReintento); alarmaReintento = null; }
        return;
      }
      let hayEmergencia = false, hayPendientesNuevos = false;
      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        if(!alertasNotificadas.has(a.id)) { alertasNotificadas.add(a.id); emitirSonidoAlarma(a.tipo === 'SOS'); }
        hayPendientesNuevos = true;
        return `<div class="tarjeta ${a.tipo === 'SOS' ? 'sos' : ''}">
          <h3 style="margin:0; font-size: 22px; color: ${a.tipo === 'SOS' ? 'var(--danger)' : 'var(--primary)'};">${a.tipo === 'SOS' ? 'üö® SOS' : 'üöó LLEGANDO'}</h3>
          <p style="font-size:22px; margin: 12px 0; font-weight: 800; color: var(--dark);">${a.domicilio}</p>
          <p style="font-size: 16px; margin: 0; color: var(--gray);"><b>${a.nombre}</b> - Hace ${a.tiempo} min</p>
          <div class="acciones-garita"><button class="btn-success" onclick="confirmarGarita('${a.id}')">CONFIRMAR VISTA</button></div>
        </div>`;
      }).join('');
      if(hayPendientesNuevos && !alarmaReintento) alarmaReintento = setInterval(() => { emitirSonidoAlarma(hayEmergencia); }, 15000);
    }

    async function confirmarGarita(id) {
      if(navigator.vibrate) navigator.vibrate(50);
      await api('confirmarAviso', { idAviso: id });
      actualizarGarita(); 
    }

    messaging.onMessage((payload) => {
      emitirSonidoAlarma(true);
      if(userActual && userActual.rol.toUpperCase() === 'VECINO') {
         document.getElementById('texto-alerta-recibida').innerText = payload.notification.body;
         document.getElementById('modal-alerta').style.display = 'flex';
      }
    });
  </script>
</body>
</html>

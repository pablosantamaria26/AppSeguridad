<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="theme-color" content="#f0f2f5">
  <title>Alerta Vecinal</title>
  
  <link rel="manifest" href="manifest.json">
  
  <style>
    /* Dise√±o 100% M√≥vil, T√°ctil y Moderno */
    :root { 
      --primary: #007aff; 
      --success: #34c759; 
      --danger: #ff3b30; 
      --dark: #1c1c1e; 
      --gray: #8e8e93;
      --bg-color: #f2f2f7;
      --card-bg: #ffffff;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0; 
      padding: 15px; 
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: var(--dark);
    }

    .container { 
      width: 100%;
      max-width: 420px; 
      background: var(--card-bg); 
      padding: 30px 25px; 
      border-radius: 24px; 
      box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
      text-align: center;
      margin-top: 10px;
    }

    h2 { margin-top: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
    p { color: var(--gray); font-size: 15px; line-height: 1.4; }

    /* Inputs Modernos */
    input { 
      width: 100%; 
      padding: 18px; 
      margin: 20px 0; 
      border: 2px solid #e5e5ea; 
      border-radius: 16px; 
      font-size: 20px; 
      font-weight: 600;
      text-align: center; 
      background-color: #fafafa;
      transition: all 0.2s ease;
    }
    input:focus { border-color: var(--primary); background-color: #fff; outline: none; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); }

    /* Botones T√°ctiles 3D */
    button { 
      width: 100%; 
      padding: 20px; 
      margin: 10px 0; 
      border: none; 
      border-radius: 20px; 
      font-size: 19px; 
      font-weight: 700; 
      color: white; 
      cursor: pointer; 
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }
    /* Efecto de hundimiento real al tocar */
    button:active { 
      transform: scale(0.94) translateY(2px); 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    }
    
    .btn-primary { background: var(--primary); box-shadow: 0 6px 20px rgba(0, 122, 255, 0.3); }
    .btn-success { background: var(--success); height: 110px; font-size: 24px; box-shadow: 0 8px 25px rgba(52, 199, 89, 0.4); }
    .btn-danger { background: var(--danger); height: 100px; font-size: 22px; box-shadow: 0 8px 25px rgba(255, 59, 48, 0.4); }
    .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 14px; font-size: 16px; box-shadow: none;}
    .btn-outline:active { background: rgba(0, 122, 255, 0.1); }

    /* Vistas */
    .vista { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    #vista-login { display: block; } 
    
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* Historial */
    .historial-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f2f2f7; font-size: 16px; font-weight: 500; }
    .historial-item:last-child { border-bottom: none; }
    .badge { padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; }
    .badge-ok { background: #e5f9e7; color: var(--success); }
    .badge-err { background: #ffebee; color: var(--danger); }
    .badge-wait { background: #fff4e5; color: #ff9500; }
    
    /* M√≥dulo Garita */
    .tarjeta { border: none; border-radius: 20px; padding: 25px; margin-bottom: 20px; text-align: left; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
    .tarjeta::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background: var(--primary); }
    .tarjeta.sos::before { background: var(--danger); }
    .tarjeta.sos { background: #fff0f0; animation: pulse 2s infinite; }
    
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

    .acciones-garita { display: flex; gap: 10px; flex-direction: column; margin-top: 20px; }
    .acciones-garita button { margin: 0; height: 70px; font-size: 20px; }
    
    #alerta-sonora-btn { display: none; background: #ff9500; box-shadow: 0 6px 20px rgba(255, 149, 0, 0.3); margin-bottom: 20px; }
    
    #loader { display: none; font-weight: bold; color: var(--primary); margin: 20px 0; font-size: 18px; }
    
    /* Barra SOS */
    .sos-container { position: relative; width: 100%; border-radius: 20px; margin-top: 20px; }
    #sos-progress { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(0,0,0,0.25); width: 0%; pointer-events: none; border-radius: 20px; transition: width 0.1s linear;}
  </style>
</head>
<body>

  <!-- ===============================
       PANTALLA 1: INGRESO
       =============================== -->
  <div class="container vista" id="vista-login">
    <div style="font-size: 40px; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h2>Seguridad Vecinal</h2>
    <p>Ingres√° el DNI o Lote proporcionado por la administraci√≥n de la cuadra.</p>
    
    <input type="number" id="inputId" inputmode="numeric" placeholder="ID de usuario">
    <button class="btn-primary" onclick="iniciarSesion()">Ingresar</button>
    
    <div id="login-error" style="color: var(--danger); margin-top: 15px; font-weight: bold;"></div>
  </div>

  <!-- ===============================
       PANTALLA 2: VECINO
       =============================== -->
  <div class="container vista" id="vista-vecino">
    <h2 id="vecino-nombre" style="font-size: 28px; margin-bottom: 5px; color: var(--primary);">Vecino</h2>
    <p id="vecino-domicilio" style="margin-bottom: 25px; font-weight: 600;"></p>
    
    <!-- Bot√≥n Principal -->
    <button class="btn-success" onclick="registrarLlegada()">üöó ESTOY LLEGANDO</button>
    <div id="mensaje-estado" style="min-height: 24px; margin: 15px 0; font-weight: bold; font-size: 18px;"></div>
    
    <!-- Bot√≥n SOS -->
    <div class="sos-container">
      <button class="btn-danger" id="btn-sos">üö® EMERGENCIA<br><small style="font-size: 14px; font-weight: normal;">(Mantener presionado)</small></button>
      <div id="sos-progress"></div>
    </div>

    <hr style="border: 0; border-top: 2px dashed #e5e5ea; margin: 35px 0 25px 0;">

    <h3 style="text-align: left; font-size: 18px; margin-bottom: 10px;">Mis √∫ltimos avisos</h3>
    <button class="btn-outline" onclick="cargarHistorial()">‚Üª Actualizar historial</button>
    <div id="lista-historial" style="text-align: left; margin-top: 15px;">
      <p style="text-align: center; color: var(--gray); font-size: 14px;">Toca actualizar para ver tus registros.</p>
    </div>
  </div>

  <!-- ===============================
       PANTALLA 3: GARITA (Operarios)
       =============================== -->
  <div class="container vista" id="vista-garita">
    <h2 style="color: var(--dark);">CENTRAL GARITA</h2>
    <p>Monitoreo en tiempo real</p>
    
    <!-- Bot√≥n Vital para habilitar notificaciones push y sonido en el navegador -->
    <button id="alerta-sonora-btn" onclick="habilitarNotificacionesYAudio()">üîî Activar Alertas Sonoras</button>
    
    <div id="lista-avisos" style="margin-top: 25px;">
      <div style="padding:40px 0; color:var(--gray); font-weight:bold; font-size:18px;">Iniciando sistema...</div>
    </div>
    
    <hr style="border: 0; border-top: 2px solid #e5e5ea; margin: 30px 0;">
    <button class="btn-danger" style="height: 80px; font-size: 24px;" onclick="window.location.href='tel:911'">üìû LLAMAR 911</button>
  </div>

  <div id="loader">Conectando... ‚è≥</div>

  <script>
    // --- 1. CONFIGURACI√ìN DEL WORKER DE CLOUDFLARE ---
    // ¬°REEMPLAZAR POR TU URL DE CLOUDFLARE (.workers.dev)!
    const API_URL = 'https://appseguridad.santamariapablodaniel.workers.dev/';
    
    let userActual = null;
    let intEstado = null; 
    let intGarita = null; 
    let idPendiente = null;
    
    // Variables para Push/Audio Garita
    let audioContexto = null;
    let alertasNotificadas = new Set();
    let alarmaReintento = null;

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(()=>{}); });
    }

    async function api(accion, payload = {}) {
      try {
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accion, payload }) });
        return await res.json();
      } catch (e) { return { error: 'Error de red. Verifique su internet.' }; }
    }

    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      document.getElementById('loader').style.display = 'none';
      if(id) document.getElementById(id).style.display = 'block';
    }

    // --- L√ìGICA DE LOGIN ---
    async function iniciarSesion() {
      const id = document.getElementById('inputId').value;
      if(!id) return;
      mostrar(''); document.getElementById('loader').style.display = 'block';
      const res = await api('login', { id });
      document.getElementById('loader').style.display = 'none';
      
      if(res.error) {
        document.getElementById('login-error').innerText = res.error;
        mostrar('vista-login');
      } else {
        userActual = res;
        if(res.rol.toUpperCase() === 'GUARDIA') {
          mostrar('vista-garita');
          document.getElementById('alerta-sonora-btn').style.display = 'block'; // Pide habilitar sonido
          loopGarita(); 
        } else {
          document.getElementById('vecino-nombre').innerText = res.nombre;
          document.getElementById('vecino-domicilio').innerText = "üìç " + res.domicilio;
          mostrar('vista-vecino');
          configurarSOS(); 
        }
      }
    }

    // --- VECINO ---
    function registrarLlegada() {
      document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--gray);">Calculando ubicaci√≥n GPS...</span>';
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude),
          err => procesarAviso('LLEGADA', null, null), { timeout: 5000, enableHighAccuracy: true }
        );
      } else { procesarAviso('LLEGADA', null, null); }
    }

    async function procesarAviso(tipo, lat, lng) {
      if(navigator.vibrate) navigator.vibrate(50); // Feedback t√°ctil instant√°neo
      const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
      
      if(res.error) {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--danger)">‚ö†Ô∏è ${res.error}</span>`;
      } else {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--primary)">‚è≥ ${res.mensaje}</span>`;
        if (tipo === 'LLEGADA') {
          idPendiente = res.idAviso;
          if(intEstado) clearInterval(intEstado);
          intEstado = setInterval(chequearConfirmacion, 5000); 
        } else if (tipo === 'SOS') {
          const link = (lat && lng) ? `https://maps.google.com/?q=${lat},${lng}` : 'Ubicaci√≥n desactivada.';
          const txt = `üö® *EMERGENCIA VECINAL* üö®\n\nSoy ${userActual.nombre}\nDom: ${userActual.domicilio}\nUbicaci√≥n actual: ${link}`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
        }
      }
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      if(res.estado === 'CONFIRMADO') {
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]); // Vibra cuando el guardia te ve
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--success)">‚úÖ ¬°Garita confirmada! Avanz√°.</span>';
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--danger)">‚ùå Expir√≥. El guardia no confirm√≥.</span>';
        clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      document.getElementById('lista-historial').innerHTML = '<p style="text-align:center; color:var(--gray);">Cargando...</p>';
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      let html = '';
      if(datos.length) {
        datos.forEach(d => {
          let badgeClass = d.estado.includes('‚úÖ') ? 'badge-ok' : (d.estado.includes('‚ùå') ? 'badge-err' : 'badge-wait');
          html += `<div class="historial-item"><span>${d.fecha}</span><span class="badge ${badgeClass}">${d.estado}</span></div>`;
        });
      } else {
        html = '<p style="text-align:center; color:var(--gray);">No hay registros.</p>';
      }
      document.getElementById('lista-historial').innerHTML = html;
    }

    // Bot√≥n SOS 2 Segundos
    function configurarSOS() {
      const btn = document.getElementById('btn-sos');
      const barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;

      const reset = () => { clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      const press = (e) => {
        e.preventDefault(); reset();
        if(navigator.vibrate) navigator.vibrate(20);
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        timer = setTimeout(() => {
          clearInterval(iterador); 
          if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]); 
          if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => procesarAviso('SOS', p.coords.latitude, p.coords.longitude), e => procesarAviso('SOS', null, null), { timeout: 5000 });
          } else { procesarAviso('SOS', null, null); }
        }, 2000);
      };
      btn.addEventListener('touchstart', press, {passive: false}); btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', reset); btn.addEventListener('mouseleave', reset);
    }

    // --- GARITA Y NOTIFICACIONES PUSH NATIVAS ---
    
    function habilitarNotificacionesYAudio() {
      // 1. Pide permiso para Notificaciones Push nativas
      if ("Notification" in window) {
        Notification.requestPermission().then(permission => {
          if(permission === "granted") console.log("Notificaciones habilitadas.");
        });
      }
      // 2. Desbloquea el motor de audio de HTML5
      audioContexto = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContexto.createOscillator();
      osc.connect(audioContexto.destination);
      osc.start(); osc.stop(audioContexto.currentTime + 0.01); // Sonido inaudible para desbloquear
      
      document.getElementById('alerta-sonora-btn').style.display = 'none';
    }

    function emitirSonidoAlarma(esSOS) {
      if(!audioContexto) return;
      if(navigator.vibrate) navigator.vibrate(esSOS ? [500,200,500,200,500] : [300, 200, 300]);
      
      const osc = audioContexto.createOscillator();
      const gain = audioContexto.createGain();
      osc.type = esSOS ? 'sawtooth' : 'sine';
      osc.frequency.setValueAtTime(esSOS ? 880 : 660, audioContexto.currentTime);
      if(esSOS) osc.frequency.exponentialRampToValueAtTime(440, audioContexto.currentTime + 0.5); // Efecto sirena
      
      osc.connect(gain); gain.connect(audioContexto.destination);
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.00001, audioContexto.currentTime + 1);
      osc.stop(audioContexto.currentTime + 1);
    }

    function dispararNotificacionPush(aviso) {
      let titulo = aviso.tipo === 'SOS' ? "üö® EMERGENCIA VECINAL" : "üöó LLEGADA";
      let cuerpo = `${aviso.nombre} - ${aviso.domicilio}`;
      
      // Notificaci√≥n Push Nativa (Aparece aunque el navegador est√© de fondo)
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(titulo, { body: cuerpo, requireInteraction: true });
      }
      emitirSonidoAlarma(aviso.tipo === 'SOS');
    }

    function loopGarita() {
      actualizarGarita();
      intGarita = setInterval(actualizarGarita, 5000); 
    }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos');
      const div = document.getElementById('lista-avisos');
      
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<div style="padding:50px 0; color:var(--gray); font-weight:600; font-size:18px;">‚úîÔ∏è Todo tranquilo.<br><small>Sin alertas pendientes.</small></div>';
        if(alarmaReintento) { clearInterval(alarmaReintento); alarmaReintento = null; }
        return;
      }

      let hayEmergencia = false;
      let hayPendientesNuevos = false;

      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        
        // ¬øEs un aviso nuevo que no son√≥?
        if(!alertasNotificadas.has(a.id)) {
          alertasNotificadas.add(a.id);
          dispararNotificacionPush(a);
        }
        hayPendientesNuevos = true;

        let icono = a.tipo === 'SOS' ? 'üö® SOS' : 'üöó LLEGANDO';
        return `
        <div class="tarjeta ${a.tipo === 'SOS' ? 'sos' : ''}">
          <h3 style="margin:0; font-size: 22px; color: ${a.tipo === 'SOS' ? 'var(--danger)' : 'var(--primary)'};">${icono}</h3>
          <p style="font-size:22px; margin: 12px 0; font-weight: 800; color: var(--dark);">
            ${a.domicilio}
          </p>
          <p style="font-size: 16px; margin: 0; color: var(--gray);">
            <b>${a.nombre}</b><br>
            Hace ${a.tiempo} min
          </p>
          <div class="acciones-garita">
            <button class="btn-success" onclick="confirmarGarita('${a.id}')">CONFIRMAR VISTA</button>
          </div>
        </div>`;
      }).join('');
      
      // Reintento Escalonado: Si hay avisos sin confirmar, suena cada 15 segundos autom√°ticamente
      if(hayPendientesNuevos && !alarmaReintento) {
        alarmaReintento = setInterval(() => { emitirSonidoAlarma(hayEmergencia); }, 15000);
      }
    }

    async function confirmarGarita(id) {
      if(navigator.vibrate) navigator.vibrate(50);
      document.getElementById('lista-avisos').innerHTML = '<p style="font-weight:bold; color:var(--primary);">Registrando...</p>';
      await api('confirmarAviso', { idAviso: id });
      actualizarGarita(); 
    }
  </script>
</body>
</html>

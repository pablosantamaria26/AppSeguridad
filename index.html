<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="theme-color" content="#f0f2f5" id="theme-color-meta">
  <title>Alerta Vecinal</title>
  
  <!-- Fundamental para iPhone -->
  <link rel="apple-touch-icon" href="icono.png">
  <link rel="manifest" href="manifest.json">
  
  <!-- SDK de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

  <style>
    /* ==========================================
       VARIABLES DE TEMAS (Cambian din√°micamente)
       ========================================== */
    :root { 
      --primary: #007aff; --success: #34c759; --danger: #ff3b30; 
      --dark: #1c1c1e; --gray: #8e8e93; --bg-color: #f2f2f7; 
      --card-bg: #ffffff; --warn: #ffcc00; --text-main: #1c1c1e;
      --input-bg: #fafafa; --border: #e5e5ea;
    }

    [data-theme="oscuro"] {
      --primary: #0a84ff; --success: #32d74b; --danger: #ff453a; 
      --dark: #ffffff; --gray: #98989d; --bg-color: #000000; 
      --card-bg: #1c1c1e; --warn: #ffd60a; --text-main: #ffffff;
      --input-bg: #2c2c2e; --border: #38383a;
    }

    [data-theme="elegante"] {
      --primary: #0ea5e9; --success: #10b981; --danger: #ef4444; 
      --dark: #f8fafc; --gray: #94a3b8; --bg-color: #0f172a; 
      --card-bg: #1e293b; --warn: #f59e0b; --text-main: #f8fafc;
      --input-bg: #0f172a; --border: #334155;
    }

    /* Dise√±o Base */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--text-main); transition: background-color 0.3s ease, color 0.3s ease; }
    .container { width: 100%; max-width: 420px; background: var(--card-bg); padding: 30px 25px; border-radius: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); text-align: center; margin-top: 10px; transition: background-color 0.3s ease; }
    h2 { margin-top: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; color: var(--dark); }
    p { color: var(--gray); font-size: 15px; line-height: 1.4; }

    input { width: 100%; padding: 18px; margin: 20px 0; border: 2px solid var(--border); border-radius: 16px; font-size: 20px; font-weight: 600; text-align: center; background-color: var(--input-bg); color: var(--text-main); transition: all 0.2s ease; }
    input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); }

    button { width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 20px; font-size: 19px; font-weight: 700; color: white; cursor: pointer; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 6px 16px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
    button:active { transform: scale(0.94) translateY(2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    .btn-primary { background: var(--primary); box-shadow: 0 6px 20px rgba(0, 122, 255, 0.2); }
    .btn-success { background: var(--success); height: 110px; font-size: 24px; box-shadow: 0 8px 25px rgba(52, 199, 89, 0.3); }
    .btn-danger { background: var(--danger); height: 100px; font-size: 22px; box-shadow: 0 8px 25px rgba(255, 59, 48, 0.3); }
    .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 14px; font-size: 16px; box-shadow: none;}

    .vista { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    #vista-login { display: block; } 
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .historial-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 16px; font-weight: 500; }
    .historial-item:last-child { border-bottom: none; }
    
    .tarjeta { border: none; border-radius: 20px; padding: 25px; margin-bottom: 20px; text-align: left; background: var(--input-bg); box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
    .tarjeta::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background: var(--primary); }
    .tarjeta.sos::before { background: var(--danger); }
    .tarjeta.sos { background: rgba(255, 59, 48, 0.1); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

    .acciones-garita { display: flex; gap: 10px; flex-direction: column; margin-top: 20px; }
    .acciones-garita button { margin: 0; height: 70px; font-size: 20px; }
    
    #loader { display: none; font-weight: bold; color: var(--primary); margin: 20px 0; font-size: 18px; }
    .sos-container { position: relative; width: 100%; border-radius: 20px; margin-top: 20px; }
    #sos-progress { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(0,0,0,0.4); width: 0%; pointer-events: none; border-radius: 20px; transition: width 0.1s linear;}

    /* Botonera de Garita */
    .grid-botones { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .grid-botones button { padding: 15px 10px; height: 90px; font-size: 14px; margin: 0; background: var(--card-bg); color: var(--dark); border: 2px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .grid-botones button span { font-size: 24px; display: block; margin-bottom: 5px; }
    .grid-botones button:active { background: var(--border); border-color: var(--primary); }

    /* Selector de Temas */
    .theme-selector { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
    .theme-selector button { padding: 10px; font-size: 13px; height: auto; margin: 0; border-radius: 12px; background: var(--input-bg); color: var(--text-main); border: 2px solid var(--border); box-shadow: none; }
    .theme-selector button:active { background: var(--border); }
    .theme-selector button.active { border-color: var(--primary); background: rgba(0, 122, 255, 0.1); color: var(--primary); font-weight: bold; }

    /* Modales de UI/UX (Reemplazan a los alert/confirm nativos) */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-top: 0; color: var(--dark); font-size: 24px; margin-bottom: 10px; }
    .modal-content p { color: var(--gray); margin-bottom: 25px; font-size: 16px; line-height: 1.5; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Notificaci√≥n Flotante (Toast) */
    .toast-notificacion { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 15px 25px; border-radius: 16px; font-weight: bold; font-size: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; transition: top 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .toast-show { top: 20px; }
  </style>
</head>
<body>

  <!-- MODAL 1: PERMISOS (Bienvenida) -->
  <div id="modal-permisos" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 15px;">üìçüîî</div>
      <h3>Permisos Necesarios</h3>
      <p>Para que la garita sepa que est√°s cerca y puedas recibir alertas cr√≠ticas, necesitamos tu permiso de ubicaci√≥n y notificaciones.</p>
      <button class="btn-primary" onclick="concederPermisosVecino()">¬°Habilitar Todo!</button>
    </div>
  </div>

  <!-- MODAL 2: CONFIRMAR ALERTA GARITA -->
  <div id="modal-confirmacion" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 10px;">‚ö†Ô∏è</div>
      <h3>¬øEnviar Alerta Global?</h3>
      <p id="texto-motivo-alerta" style="font-size: 18px; font-weight: bold; color: var(--danger); margin-bottom: 10px;"></p>
      <p>Esto har√° sonar los celulares de todos los vecinos.</p>
      <div style="display: flex; gap: 10px;">
        <button class="btn-outline" onclick="cerrarModalConfirmacion()" style="margin:0;">Cancelar</button>
        <button class="btn-danger" id="btn-ejecutar-alerta" style="margin:0;">S√≠, Enviar</button>
      </div>
    </div>
  </div>

  <!-- MODAL 3: ALERTA RECIBIDA (Para el vecino) -->
  <div id="modal-alerta" class="modal-overlay">
    <div class="modal-content">
      <div style="font-size: 55px; margin-bottom: 10px;">üö®</div>
      <h3 style="color: var(--danger);">ALERTA DE GARITA</h3>
      <p id="texto-alerta-recibida" style="font-size: 20px; font-weight: bold; color: var(--dark);"></p>
      <button class="btn-primary" onclick="cerrarModalAlerta()">Entendido</button>
    </div>
  </div>

  <!-- TOAST NOTIFICACI√ìN FLOTANTE -->
  <div id="toast-exito" class="toast-notificacion">‚úÖ Alerta enviada con √©xito</div>

  <!-- PANTALLA 1: INGRESO -->
  <div class="container vista" id="vista-login">
    <div style="font-size: 40px; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h2>Seguridad Vecinal</h2>
    <p>Ingres√° el DNI o Lote de tu domicilio.</p>
    <input type="number" id="inputId" inputmode="numeric" placeholder="ID de usuario">
    <button class="btn-primary" onclick="iniciarSesion()">Ingresar</button>
    <div id="login-error" style="color: var(--danger); margin-top: 15px; font-weight: bold;"></div>
  </div>

  <!-- PANTALLA 2: VECINO -->
  <div class="container vista" id="vista-vecino">
    <h2 id="vecino-nombre" style="font-size: 28px; margin-bottom: 5px; color: var(--primary);">Vecino</h2>
    <p id="vecino-domicilio" style="margin-bottom: 25px; font-weight: 600; color: var(--dark);"></p>
    
    <button class="btn-success" onclick="registrarLlegada()">üöó ESTOY LLEGANDO</button>
    <div id="mensaje-estado" style="min-height: 24px; margin: 15px 0; font-weight: bold; font-size: 18px;"></div>
    
    <div class="sos-container">
      <button class="btn-danger" id="btn-sos">üö® EMERGENCIA<br><small style="font-size: 14px; font-weight: normal;">(Mantener presionado)</small></button>
      <div id="sos-progress"></div>
    </div>

    <hr style="border: 0; border-top: 2px dashed var(--border); margin: 35px 0 25px 0;">
    
    <h3 style="text-align: left; font-size: 18px; margin-bottom: 10px;">Mis √∫ltimos avisos</h3>
    <button class="btn-outline" onclick="cargarHistorial()">‚Üª Actualizar historial</button>
    <div id="lista-historial" style="text-align: left; margin-top: 15px;"></div>

    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0 15px 0;">
    <p style="text-align: left; margin: 0 0 5px 0; font-size: 14px; font-weight: bold;">üé® Apariencia de la App</p>
    <div class="theme-selector">
      <button id="btn-tema-claro" onclick="cambiarTema('claro')">‚òÄÔ∏è Claro</button>
      <button id="btn-tema-oscuro" onclick="cambiarTema('oscuro')">üåô Oscuro</button>
      <button id="btn-tema-elegante" onclick="cambiarTema('elegante')">üåå Elegante</button>
    </div>
  </div>

  <!-- PANTALLA 3: GARITA -->
  <div class="container vista" id="vista-garita">
    <h2>CENTRAL GARITA</h2>
    <button id="btn-habilitar-push" class="btn-primary" onclick="habilitarNotificaciones()" style="background:var(--warn); color:#000; box-shadow:none;">üîî Activar Alertas</button>
    
    <div id="lista-avisos" style="margin-top: 25px;">
      <div style="padding:40px 0; color:var(--gray); font-weight:bold; font-size:18px;">Iniciando sistema...</div>
    </div>
    
    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0;">
    <h3 style="text-align:left; color:var(--gray); font-size: 14px;">EMITIR ALERTA A VECINOS</h3>
    <div class="grid-botones">
      <button onclick="abrirModalConfirmacion('Sospechoso merodeando')"><span>üïµÔ∏è‚Äç‚ôÇÔ∏è</span>Sospechoso</button>
      <button onclick="abrirModalConfirmacion('Veh√≠culo desconocido')"><span>üöò</span>Veh√≠culo Raro</button>
      <button onclick="abrirModalConfirmacion('Ruidos molestos detectados')"><span>üîä</span>Ruidos</button>
      <button onclick="abrirModalConfirmacion('Falla de suministro el√©ctrico/agua')"><span>‚ö†Ô∏è</span>Corte Luz/Agua</button>
      <button onclick="abrirModalConfirmacion('Incendio o humo detectado')"><span>üî•</span>Incendio/Humo</button>
      <button onclick="abrirModalConfirmacion('Aviso general de seguridad')"><span>üì¢</span>Aviso General</button>
    </div>
    <hr style="border: 0; border-top: 2px solid var(--border); margin: 30px 0;">
    <button class="btn-danger" style="height: 70px; font-size: 20px;" onclick="window.location.href='tel:911'">üìû LLAMAR 911</button>
  </div>

  <div id="loader">Conectando... ‚è≥</div>

  <script>
    // ====================================================================
    // CONFIGURACI√ìN DE FIREBASE Y CLOUDFLARE
    // ====================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCD5Ji6o5t4HQo_6Hpj33Sz3PzzuH0JF9Y",
      authDomain: "app-vendedores-inteligente.firebaseapp.com",
      projectId: "app-vendedores-inteligente",
      storageBucket: "app-vendedores-inteligente.firebasestorage.app",
      messagingSenderId: "583313989429",
      appId: "1:583313989429:web:2d3663e547b609e211367c"
    };
    const VAPID_KEY = "BN480IhH70femCH6611oE699tLXFGYbS4MWcTbcEMbOUkR0vIwxXPrzTjhJEB9JcizJxqu4xs91-bQsal1_Hi8o";
    const API_URL = 'https://appseguridad.santamariapablodaniel.workers.dev/';

    // --- MANEJO DE TEMAS ---
    function cambiarTema(tema) {
      document.documentElement.setAttribute('data-theme', tema);
      localStorage.setItem('temaVecinal', tema);
      
      const metaColor = document.getElementById('theme-color-meta');
      if(tema === 'oscuro') metaColor.setAttribute('content', '#000000');
      else if(tema === 'elegante') metaColor.setAttribute('content', '#0f172a');
      else metaColor.setAttribute('content', '#f2f2f7');

      document.querySelectorAll('.theme-selector button').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-tema-' + tema)?.classList.add('active');
    }
    const temaGuardado = localStorage.getItem('temaVecinal') || 'claro';
    cambiarTema(temaGuardado);

    // --- INICIALIZAR FIREBASE ---
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    let userActual = null;
    let intEstado = null; 
    let intGarita = null; 
    let idPendiente = null;
    let audioContexto = null;
    let alertasNotificadas = new Set();
    let alarmaReintento = null;
    let swRegistration = null; 
    let motivoAlertaActual = ""; // Guarda el motivo temporalmente para el modal

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { 
        navigator.serviceWorker.register('./firebase-messaging-sw.js')
          .then(registration => {
            swRegistration = registration;
            console.log('Service Worker registrado.');
          }).catch(err => console.log('Error en SW:', err));
      });
    }

    async function api(accion, payload = {}) {
      try {
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accion, payload }) });
        return await res.json();
      } catch (e) { return { error: 'Error de red.' }; }
    }

    function mostrar(id) {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      document.getElementById('loader').style.display = 'none';
      if(id) document.getElementById(id).style.display = 'block';
    }

    async function iniciarSesion() {
      const id = document.getElementById('inputId').value;
      if(!id) return;
      mostrar(''); document.getElementById('loader').style.display = 'block';
      const res = await api('login', { id });
      document.getElementById('loader').style.display = 'none';
      
      if(res.error) {
        document.getElementById('login-error').innerText = res.error;
        mostrar('vista-login');
      } else {
        userActual = res;
        
        if(res.rol.toUpperCase() === 'GUARDIA') {
          mostrar('vista-garita');
          document.getElementById('btn-habilitar-push').style.display = 'block';
          loopGarita(); 
        } else {
          document.getElementById('vecino-nombre').innerText = res.nombre;
          document.getElementById('vecino-domicilio').innerText = "üìç " + res.domicilio;
          mostrar('vista-vecino');
          configurarSOS(); 
          
          if (Notification.permission !== "granted") {
            document.getElementById('modal-permisos').style.display = 'flex';
          } else {
            obtenerYGuardarToken();
          }
        }
      }
    }

    // --- MODALES Y UI CUSTOM ---
    function concederPermisosVecino() {
      audioContexto = new (window.AudioContext || window.webkitAudioContext)();
      if(navigator.geolocation) navigator.geolocation.getCurrentPosition(()=>{}, ()=>{});
      
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') obtenerYGuardarToken();
      });
      document.getElementById('modal-permisos').style.display = 'none';
    }

    function habilitarNotificaciones() {
      document.getElementById('btn-habilitar-push').style.display = 'none';
      audioContexto = new (window.AudioContext || window.webkitAudioContext)(); 
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') obtenerYGuardarToken();
      });
    }

    function obtenerYGuardarToken() {
      if (!swRegistration) {
        setTimeout(obtenerYGuardarToken, 1000);
        return;
      }
      messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: swRegistration })
        .then(currentToken => {
          if (currentToken) {
            console.log("Token obtenido");
            api('guardarToken', { idUsuario: userActual.id, token: currentToken });
          }
        }).catch(err => console.error("Error token:", err));
    }

    function mostrarToastExito() {
      const toast = document.getElementById('toast-exito');
      toast.classList.add('toast-show');
      setTimeout(() => toast.classList.remove('toast-show'), 3000);
    }

    function cerrarModalAlerta() {
      document.getElementById('modal-alerta').style.display = 'none';
    }

    // --- VECINO ---
    function registrarLlegada() {
      document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--gray);">Ubicando GPS...</span>';
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => procesarAviso('LLEGADA', pos.coords.latitude, pos.coords.longitude),
          err => procesarAviso('LLEGADA', null, null), { timeout: 5000 }
        );
      } else { procesarAviso('LLEGADA', null, null); }
    }

    async function procesarAviso(tipo, lat, lng) {
      if(navigator.vibrate) navigator.vibrate(50);
      const res = await api('registrarAviso', { usuario: userActual, tipo, lat, lng });
      if(res.error) {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--danger)">‚ö†Ô∏è ${res.error}</span>`;
      } else {
        document.getElementById('mensaje-estado').innerHTML = `<span style="color:var(--primary)">‚è≥ ${res.mensaje}</span>`;
        if (tipo === 'LLEGADA') {
          idPendiente = res.idAviso;
          if(intEstado) clearInterval(intEstado);
          intEstado = setInterval(chequearConfirmacion, 5000); 
        } else if (tipo === 'SOS') {
          const link = (lat && lng) ? `https://maps.google.com/?q=${lat},${lng}` : 'Sin GPS.';
          const txt = `üö® *EMERGENCIA VECINAL* üö®\n\nSoy ${userActual.nombre}\nDom: ${userActual.domicilio}\nUbicaci√≥n: ${link}`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
        }
      }
    }

    async function chequearConfirmacion() {
      const res = await api('verificarEstado', { idAviso: idPendiente });
      if(res.estado === 'CONFIRMADO') {
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--success)">‚úÖ ¬°Garita confirmada! Avanz√°.</span>';
        clearInterval(intEstado);
      } else if (res.estado === 'EXPIRADO') {
        document.getElementById('mensaje-estado').innerHTML = '<span style="color:var(--danger)">‚ùå Expir√≥. El guardia no confirm√≥.</span>';
        clearInterval(intEstado);
      }
    }

    async function cargarHistorial() {
      const datos = await api('obtenerHistorial', { idUsuario: userActual.id });
      let html = datos.length ? datos.map(d => `<div class="historial-item"><span>${d.fecha}</span><span>${d.estado}</span></div>`).join('') : '<p>Sin registros.</p>';
      document.getElementById('lista-historial').innerHTML = html;
    }

    function configurarSOS() {
      const btn = document.getElementById('btn-sos');
      const barra = document.getElementById('sos-progress');
      let timer, ancho = 0, iterador;

      const reset = () => { clearTimeout(timer); clearInterval(iterador); ancho = 0; barra.style.width = '0%'; };
      const press = (e) => {
        e.preventDefault(); reset();
        if(navigator.vibrate) navigator.vibrate(20);
        iterador = setInterval(() => { ancho += 5; barra.style.width = ancho + '%'; }, 100);
        timer = setTimeout(() => {
          clearInterval(iterador); 
          if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]); 
          navigator.geolocation?.getCurrentPosition(p => procesarAviso('SOS', p.coords.latitude, p.coords.longitude), e => procesarAviso('SOS', null, null));
        }, 2000);
      };
      btn.addEventListener('touchstart', press, {passive: false}); btn.addEventListener('touchend', reset);
      btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', reset); btn.addEventListener('mouseleave', reset);
    }

    // --- GARITA ---
    function abrirModalConfirmacion(motivo) {
      motivoAlertaActual = motivo;
      document.getElementById('texto-motivo-alerta').innerText = `"${motivo}"`;
      document.getElementById('modal-confirmacion').style.display = 'flex';
    }

    function cerrarModalConfirmacion() {
      document.getElementById('modal-confirmacion').style.display = 'none';
      motivoAlertaActual = "";
    }

    document.getElementById('btn-ejecutar-alerta').addEventListener('click', async () => {
      if(!motivoAlertaActual) return;
      const motivo = motivoAlertaActual;
      cerrarModalConfirmacion();
      
      document.getElementById('lista-avisos').innerHTML = '<p>Enviando Alerta a Vecinos...</p>';
      await api('alertaGarita', { motivo: motivo });
      mostrarToastExito();
      actualizarGarita();
    });

    function emitirSonidoAlarma(esSOS) {
      if(!audioContexto) return;
      if(navigator.vibrate) navigator.vibrate(esSOS ? [500,200,500,200,500] : [300, 200, 300]);
      const osc = audioContexto.createOscillator();
      const gain = audioContexto.createGain();
      osc.type = esSOS ? 'sawtooth' : 'sine';
      osc.frequency.setValueAtTime(esSOS ? 880 : 660, audioContexto.currentTime);
      if(esSOS) osc.frequency.exponentialRampToValueAtTime(440, audioContexto.currentTime + 0.5);
      osc.connect(gain); gain.connect(audioContexto.destination);
      osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioContexto.currentTime + 1); osc.stop(audioContexto.currentTime + 1);
    }

    function loopGarita() {
      actualizarGarita();
      intGarita = setInterval(actualizarGarita, 5000); 
    }

    async function actualizarGarita() {
      const avisos = await api('obtenerAvisos');
      const div = document.getElementById('lista-avisos');
      
      if(avisos.error || !avisos.length) {
        div.innerHTML = '<div style="padding:50px 0; color:var(--gray); font-weight:600; font-size:18px;">‚úîÔ∏è Todo tranquilo.<br><small>Sin alertas pendientes.</small></div>';
        if(alarmaReintento) { clearInterval(alarmaReintento); alarmaReintento = null; }
        return;
      }

      let hayEmergencia = false, hayPendientesNuevos = false;
      div.innerHTML = avisos.map(a => {
        if(a.tipo === 'SOS') hayEmergencia = true;
        if(!alertasNotificadas.has(a.id)) {
          alertasNotificadas.add(a.id);
          emitirSonidoAlarma(a.tipo === 'SOS'); 
        }
        hayPendientesNuevos = true;
        let icono = a.tipo === 'SOS' ? 'üö® SOS' : 'üöó LLEGANDO';
        return `
        <div class="tarjeta ${a.tipo === 'SOS' ? 'sos' : ''}">
          <h3 style="margin:0; font-size: 22px; color: ${a.tipo === 'SOS' ? 'var(--danger)' : 'var(--primary)'};">${icono}</h3>
          <p style="font-size:22px; margin: 12px 0; font-weight: 800; color: var(--dark);">${a.domicilio}</p>
          <p style="font-size: 16px; margin: 0; color: var(--gray);"><b>${a.nombre}</b><br>Hace ${a.tiempo} min</p>
          <div class="acciones-garita">
            <button class="btn-success" onclick="confirmarGarita('${a.id}')">CONFIRMAR VISTA</button>
          </div>
        </div>`;
      }).join('');
      
      if(hayPendientesNuevos && !alarmaReintento) {
        alarmaReintento = setInterval(() => { emitirSonidoAlarma(hayEmergencia); }, 15000);
      }
    }

    async function confirmarGarita(id) {
      if(navigator.vibrate) navigator.vibrate(50);
      document.getElementById('lista-avisos').innerHTML = '<p style="font-weight:bold; color:var(--primary);">Registrando...</p>';
      await api('confirmarAviso', { idAviso: id });
      actualizarGarita(); 
    }

    // Escucha notificaciones cuando la app est√° abierta en pantalla
    messaging.onMessage((payload) => {
      console.log('Push recibido', payload);
      emitirSonidoAlarma(true);
      if(userActual && userActual.rol.toUpperCase() === 'VECINO') {
         // Reemplazamos el alert() nativo por el modal custom
         document.getElementById('texto-alerta-recibida').innerText = payload.notification.body;
         document.getElementById('modal-alerta').style.display = 'flex';
      }
    });
  </script>
</body>
</html>
